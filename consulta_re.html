<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>RITE ‚Ä¢ Consulta por RE</title>
<style>
:root{
  --y:#ffff00; --yn:#f9ff7a; --bg:#000; --bg2:#050509;
  --card:rgba(10,10,15,.96); --bd:rgba(255,255,0,.18);
  --mut:#cfcfcf; --sh:0 14px 40px rgba(0,0,0,.85); --r:18px;
}
*{box-sizing:border-box}
body{margin:0;min-height:100vh;font-family:Arial,Helvetica,sans-serif;color:var(--y);
  background:radial-gradient(circle at top,#202020 0,var(--bg2) 52%,var(--bg) 100%);
}
.wrap{max-width:980px;margin:0 auto;padding:14px}
.top{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;
  padding:14px 16px;border:1px solid var(--bd);border-radius:18px;
  background:linear-gradient(180deg,rgba(10,10,15,.96),rgba(5,5,9,.92));
  box-shadow:var(--sh);
}
h1{margin:0;font-size:18px;letter-spacing:.6px}
.sub{color:var(--mut);font-size:12px;margin-top:4px}
.badge{padding:8px 10px;border-radius:999px;font-weight:900;font-size:12px;white-space:nowrap;
  background:rgba(255,255,0,.16);color:var(--y);border:1px solid rgba(255,255,0,.25);
}
.badge.ok{background:var(--y);color:#0b0b10;border:1px solid rgba(0,0,0,.2)}
.card{margin-top:14px;background:var(--card);border:1px solid var(--bd);border-radius:18px;box-shadow:var(--sh);padding:14px}
.pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;
  border:1px solid rgba(255,255,0,.22);background:rgba(0,0,0,.25);font-size:12px;color:var(--mut);
}
.sep{height:1px;background:rgba(255,255,0,.14);margin:12px 0}
.row{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
.field{grid-column:span 12;display:flex;flex-direction:column;gap:6px}
.field label{font-size:12px;color:var(--mut)}
input{width:100%;border-radius:12px;border:1px solid rgba(255,255,0,.22);
  background:rgba(0,0,0,.35);color:var(--y);padding:10px 12px;outline:none;
}
input{-webkit-text-fill-color:var(--y);}
input:focus{outline:2px solid rgba(255,255,0,.28);}
input:-webkit-autofill,
input:-webkit-autofill:hover,
input:-webkit-autofill:focus{
  -webkit-text-fill-color:var(--y) !important;
  -webkit-box-shadow: 0 0 0px 1000px rgba(0,0,0,.45) inset !important;
  transition: background-color 9999s ease-out 0s;
}
button{border:0;border-radius:14px;padding:10px 14px;font-weight:900;cursor:pointer;
  background:rgba(255,255,0,.14);color:var(--y);border:1px solid rgba(255,255,0,.28);
}
button.primary{background:var(--y);color:#0b0b10;border:1px solid rgba(0,0,0,.2)}
.muted{color:var(--mut);font-size:12px}
.list{display:grid;gap:10px;margin-top:10px}
.item{padding:12px;border-radius:16px;border:1px solid rgba(255,255,0,.18);background:rgba(0,0,0,.25);
  display:flex;justify-content:space-between;gap:10px;align-items:flex-start;
}
.item b{color:var(--y)}
.right{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
.pill2{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;
  border:1px solid rgba(255,255,0,.22);background:rgba(0,0,0,.25);font-size:12px;color:var(--yn);
}
.tiny{padding:7px 10px;border-radius:12px;font-size:12px}

.modal{position:fixed;inset:0;background:rgba(0,0,0,.72);display:none;align-items:center;justify-content:center;padding:12px;z-index:9999}
.modal .box{width:min(980px,100%);max-height:92vh;overflow:auto;background:rgba(10,10,15,.98);border:1px solid rgba(255,255,0,.22);border-radius:18px;box-shadow:var(--sh);padding:14px}
.modal .head{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
.sumula{background:#fff;color:#111;border-radius:12px;padding:0;margin-top:12px}
.page{padding:18px 18px 14px 18px;border-bottom:1px dashed #bbb}
.page:last-child{border-bottom:none}
.s-title{font-weight:900;text-align:center;letter-spacing:.4px}
.s-sub{text-align:center;font-size:12px;color:#333;margin-top:4px}
.s-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
.s-line{border:1px solid #333;padding:8px;font-size:12px}
.s-line b{display:block;font-size:11px;color:#333;margin-bottom:3px}
.s-table{width:100%;border-collapse:collapse;font-size:11px;margin-top:10px}
.s-table td,.s-table th{border:1px solid #333;padding:6px;vertical-align:top}
.s-table th{background:#f2f2f2}
.sig{display:flex;gap:14px;align-items:flex-end;justify-content:space-between;margin-top:16px}
.sig img{max-width:320px;height:auto;border:1px solid #333;padding:6px}
.sig .block{flex:1;font-size:11px}
.sig .line{border-top:1px solid #333;margin-top:30px;padding-top:4px}

@media print {
  body{background:#fff;color:#111}
  .wrap,.top,.card,.modal{display:none!important}
  #printArea{display:block!important}
  #printArea .page{page-break-after:always}
  #printArea .page:last-child{page-break-after:auto}
}
</style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div>
      <h1>RITE ‚Ä¢ Consulta por RE</h1>
      <div class="sub">Digite o RE para ver as avalia√ß√µes e abrir a s√∫mula. (Sem login)</div>
    </div>
    <div id="badge" class="badge">OFFLINE</div>
  </div>

  <div class="card">
    <div class="pill">üîé Consulta</div>
    <div class="sep"></div>
    <div class="row">
      <div class="field" style="grid-column:span 8">
        <label>RE</label>
        <input id="consultaRE" placeholder="Ex.: 123456-7" inputmode="text" autocomplete="off">
      </div>
      <div class="field" style="grid-column:span 4;align-self:end">
        <button class="primary" id="btnConsultar">Consultar</button>
      </div>
    </div>
    <div class="sep"></div>
    <div class="muted" id="hint">
      Dica: se aparecer ‚Äúnenhum registro‚Äù, confira se o RE est√° no formato certo (ex.: 123456-7).
    </div>
    <div class="list" id="consultaList"></div>
  </div>
</div>

<!-- MODAL -->
<div id="modal" class="modal">
  <div class="box">
    <div class="head">
      <div>
        <div class="pill2" id="modalTitle">üìÑ S√∫mula</div>
        <div class="muted" id="modalSub"></div>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
        <button id="btnPrint" class="primary">Imprimir / Salvar PDF</button>
        <button id="btnCloseModal">Fechar</button>
      </div>
    </div>
    <div id="modalBody"></div>
  </div>
</div>

<div id="printArea" style="display:none"></div>

<script>
/*************** AJUSTE AQUI SE PRECISAR ***************/
const DATABASE_URL = "https://rite-fa75b-default-rtdb.firebaseio.com";
const INSTRUTOR_USER = "Fenille"; // para buscar assinatura em config/instrutores/<nome>/assinatura

/*************** TEXTOS + REGRAS (mesmos do sistema) ***************/
const TEXTOS = {
  PPA_PISTOLA: {
    proc: [
      "Mediante ordem preparar a pistola para executar a ‚ÄúPPA‚Äù colocando-a no coldre (alimentada, carregada, c√£o desarmado, travada, coldre abotoado). Primeiro carregador com 6 (seis) cartuchos; um carregador de reposi√ß√£o com 10 (dez) cartuchos.",
      "Ao sinal convencionado sacar a pistola e colocar-se em prote√ß√£o no abrigo ‚ÄùA‚Äù, com rapidez, em condi√ß√µes de atuar e disparar",
      "Varredura e sa√≠da do abrigo ‚ÄúA‚Äù",
      "Primeira progress√£o (do abrigo ‚ÄúA‚Äù at√© o abrigo ‚ÄúB‚Äù)",
      "Proteger-se e atuar corretamente no abrigo ‚ÄúB‚Äù e progress√£o at√© o abrigo ‚ÄúC‚Äù",
      "Proteger-se e atuar corretamente no abrigo ‚ÄúC‚Äù e progress√£o at√© o abrigo ‚ÄúD‚Äù",
      "Proteger-se e atuar corretamente na ‚Äújanela baixa‚Äù (abrigo ‚ÄúD‚Äù)",
      "Proteger-se e atuar corretamente no canto da direita (abrigo ‚ÄúD)",
      "Primeira verbaliza√ß√£o obrigat√≥ria, com posi√ß√£o correta da arma (abrigo ‚ÄúD‚Äù)",
      "Proteger-se e atuar corretamente na ‚Äújanela alta‚Äù (abrigo ‚ÄúD‚Äù)",
      "Proteger-se e atuar corretamente no canto da esquerda (abrigo ‚ÄúD‚Äù)",
      "Segunda verbaliza√ß√£o obrigat√≥ria, com posi√ß√£o correta da arma (abrigo ‚ÄúD‚Äù)",
      "Terceira verbaliza√ß√£o obrigat√≥ria, com posi√ß√£o correta da arma (abrigo ‚ÄúD‚Äù)",
      "Recarregar a pistola corretamente, com rapidez, protegido, e sem perder o contato visual com a √°rea de perigo (recarga t√°tica ou emergencial, a crit√©rio do aluno).",
      "Atuar com a pistola sempre carregada",
      "Efetuar os disparos com rapidez (dois de cada vez em cada alvo atir√°vel).",
      "Conduzir a pistola corretamente, com o cano e o olhar na dire√ß√£o do perigo.",
      "Dedo fora do gatilho quando dos deslocamentos, e quando n√£o for para atirar",
      "Outras verbaliza√ß√µes, com posi√ß√£o correta da arma.",
      "Aplica√ß√£o de sinais policiais, em situa√ß√µes obrigat√≥rias, como se estivesse com um companheiro",
      "Proteger-se corretamente nos demais procedimentos.",
      "Regress√£o (do abrigo ‚ÄúD‚Äù at√© o abrigo ‚ÄúA‚Äù)",
      "Terminada a regress√£o coldrear a pistola, em seguran√ßa, sem descarreg√°-la, travada. Aguardar ordens",
      "Mediante ordem retirar a pistola do coldre, descarreg√°-la, com seguran√ßa, entregando-a ao professor como se a estivesse entregando na reserva de armas ou a outro companheiro",
      "Solu√ß√£o de incidentes de tiro (caso ocorram)"
    ],
    pen: [
      "Arma e equipamentos mal ajustados ao corpo atrapalhando a execu√ß√£o dos exerc√≠cios.",
      "Disparo, sem acerto, em alvo n√£o atir√°vel. Cada disparo uma penalidade. Ver item seguinte",
      "Acerto em alvo n√£o atir√°vel. Cada acerto duas penalidades. Ver item anterior (um n√£o exclui o outro)",
      "Disparos no mesmo alvo, al√©m do determinado (cada disparo a mais uma penalidade)",
      "Deixar de disparar contra alvo agressor obrigatoriamente atir√°vel (cada disparo uma penalidade).",
      "N√£o manter a arma em ‚Äúposi√ß√£o de tiro‚Äù, efetuando ‚Äúvarredura‚Äù, ap√≥s os disparos",
      "Derrubar o carregador de reposi√ß√£o",
      "Acionar o gatilho estando a pistola travada ou descarregada.",
      "Ultrapassar a arma, ou qualquer parte do corpo, para al√©m da zona de seguran√ßa.",
      "N√£o completar a pista por falta de muni√ß√£o (uma penalidade para cada tiro faltante).",
      "Precipitar-se. Praticar a valentia perigosa. N√£o pedir apoio quando necess√°rio."
    ],
    rep: [
      "Apresentar descontrole emocional",
      "Atentar contra as normas de seguran√ßa",
      "Demonstrar dificuldades no manejo ou na atua√ß√£o com a pistola.",
      "Disparar para fora do barranco de conten√ß√£o dos proj√©teis.",
      "Disparo acidental com ou sem v√≠tima.",
      "Derrubar a pistola."
    ]
  },
  PPA_ESP12: {
    proc: [
      "Mediante ordem preparar a espingarda para executar a ‚ÄúPPA‚Äù (alimentada; dep√≥sito com 3 cartuchos, mais 5 de reposi√ß√£o no porta cartuchos, todos ‚Äúsingular‚Äù ‚Äì proj√©til √∫nico; em bandoleira de tr√™s pontos individualizada; ‚Äúposi√ß√£o sul‚Äù)",
      "Ao sinal convencionado carregar a espingarda e colocar-se em prote√ß√£o no abrigo ‚ÄùA‚Äù, com rapidez, em condi√ß√µes de atuar e disparar",
      "Varredura e sa√≠da do primeiro abrigo (abrigo ‚ÄúA‚Äù)",
      "Primeira progress√£o (do abrigo ‚ÄúA‚Äù at√© o abrigo ‚ÄúB‚Äù)",
      "Proteger-se e atuar corretamente no abrigo ‚ÄúB‚Äù e progress√£o at√© o abrigo ‚ÄúC‚Äù",
      "Proteger-se e atuar corretamente no abrigo ‚ÄúC‚Äù e progress√£o at√© o abrigo ‚ÄúD‚Äù",
      "Proteger-se e atuar corretamente na ‚Äújanela baixa‚Äù (abrigo ‚ÄúD‚Äù)",
      "Proteger-se e atuar corretamente no canto da direita (abrigo ‚ÄúD‚Äù)",
      "Primeira verbaliza√ß√£o obrigat√≥ria, com posi√ß√£o correta da arma (abrigo ‚ÄúD‚Äù)",
      "Proteger-se e atuar corretamente na ‚Äújanela alta‚Äù (abrigo ‚ÄúD‚Äù)",
      "Proteger-se e atuar corretamente no canto da esquerda (abrigo ‚ÄúD‚Äù)",
      "Segunda verbaliza√ß√£o obrigat√≥ria, com posi√ß√£o correta da arma (abrigo ‚ÄúD‚Äù)",
      "Terceira verbaliza√ß√£o obrigat√≥ria, com posi√ß√£o correta da arma (abrigo ‚ÄúD‚Äù)",
      "Realimentar e recarregar a espingarda corretamente, com rapidez, protegido, e sem perder o contato visual com a √°rea de perigo (t√°tica ou emergencial, a crit√©rio do aluno).",
      "Atuar com a espingarda sempre carregada",
      "Efetuar o disparo com rapidez (um disparo em cada alvo atir√°vel)",
      "Conduzir a espingarda corretamente, com o cano e o olhar na dire√ß√£o do perigo.",
      "Dedo fora do gatilho quando dos deslocamentos, e quando n√£o for para atirar",
      "Outras verbaliza√ß√µes, com posi√ß√£o correta da arma.",
      "Aplica√ß√£o de sinais policiais, em situa√ß√µes obrigat√≥rias, como se estivesse com um companheiro",
      "Proteger-se corretamente nos demais procedimentos.",
      "Regress√£o (do abrigo ‚ÄúD‚Äù at√© o abrigo ‚ÄúA‚Äù).",
      "Terminada a regress√£o colocar a espingarda em ‚Äúposi√ß√£o sul‚Äù, gatilho travado, sem descarreg√°-la. Aguardar ordens",
      "Mediante ordem, descarregar a espingarda, com seguran√ßa, entregando-a ao professor, como se a estivesse entregando na reserva de armas, ou a outro companheiro",
      "Solu√ß√£o de incidentes de tiro (caso ocorram)"
    ],
    pen: [
      "Arma e equipamentos mal ajustados ao corpo atrapalhando a execu√ß√£o dos exerc√≠cios.",
      "Disparo, sem acerto, em alvo n√£o atir√°vel. Cada disparo uma penalidade. Ver item seguinte",
      "Acerto em alvo n√£o atir√°vel. Cada acerto duas penalidades. Ver item anterior (um n√£o exclui o outro)",
      "Disparos no mesmo alvo, al√©m do determinado (cada disparo a mais uma penalidade)",
      "Deixar de disparar contra alvo agressor obrigatoriamente atir√°vel (cada disparo uma penalidade).",
      "Recarregar e manter a arma em ‚Äúposi√ß√£o de tiro‚Äù, efetuando ‚Äúvarredura‚Äù, ap√≥s os disparos",
      "Derrubar muni√ß√£o de reposi√ß√£o",
      "Acionar o gatilho estando a espingarda descarregada ou com o gatilho travado.",
      "Ultrapassar a arma, ou qualquer parte do corpo, para al√©m da zona de seguran√ßa.",
      "N√£o completar a pista por falta de muni√ß√£o (uma penalidade para cada tiro faltante).",
      "Precipitar-se. Praticar a valentia perigosa. N√£o pedir apoio quando necess√°rio."
    ],
    rep: [
      "Apresentar descontrole emocional",
      "Atentar contra as normas de seguran√ßa",
      "Demonstrar dificuldades no manejo ou na atua√ß√£o com a espingarda.",
      "Disparar para fora do barranco de conten√ß√£o dos proj√©teis.",
      "Disparo acidental com ou sem v√≠tima.",
      "Derrubar a espingarda."
    ]
  }
};

const RULES = {
  PPA_PISTOLA: { max: 350, procCount: 25, procPts: 10, penPts: 10 },
  PPA_ESP12:   { max: 350, procCount: 25, procPts: 10, penPts: 10 }
};

const $ = (id)=>document.getElementById(id);
const safe=(s)=>(s??"").toString().trim();
const isDesktop=()=> window.matchMedia("(min-width: 920px)").matches;

function setBadge(text, ok){
  const b=$("badge");
  b.textContent=text;
  b.classList.toggle("ok", !!ok);
}

/*************** REST HELPERS ***************/
async function rtdbGet(path, query=""){
  const url = `${DATABASE_URL}/${path}.json${query}`;
  const res = await fetch(url);
  if(!res.ok) throw new Error(await res.text());
  return await res.json();
}

/*************** CONCEITO ***************/
function conceitoPorNota(n){
  const pct = (n/350)*100;
  if (pct <= 49) return "Insuficiente";
  if (pct <= 69) return "Regular";
  if (pct <= 84) return "Bom";
  if (pct <= 95) return "Muito bom";
  return "Excepcional";
}

/*************** S√öMULA ***************/
function escHtml(s){ return (s??"").toString().replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }

async function fetchAssinatura(){
  try{
    const sig = await rtdbGet(`config/instrutores/${encodeURIComponent(INSTRUTOR_USER)}/assinatura`);
    return sig && sig.dataUrl ? sig : null;
  }catch(e){ return null; }
}

function renderSumulaHTML(id, obj, sig){
  const a = obj.aluno1 || {};
  const c = obj.correcao || {};
  const rule = RULES[obj.tipo] || {max:350, shots:0, procCount:0, procPts:10, penPts:10};
  const T = TEXTOS[obj.tipo] || {proc:[], pen:[], rep:[]};

  const tituloTopo = (obj.tipo==="PPA_PISTOLA")
    ? `CAP√çTULO 19 (Manual da Pistola)<br>PMESP - TDPV - ‚ÄúM√âTODO GIRALDI‚Äù¬Æ`
    : `CAP√çTULO 19 (Manual da Espingarda 12)<br>PMESP - TDPV - ‚ÄúM√âTODO GIRALDI‚Äù¬Æ`;

  const armaTitulo = (obj.tipo==="PPA_PISTOLA")
    ? `PISTOLA SEMIAUTOM√ÅTICA .40 S&W<br><b>S√öMULA PARA HABILITAR USU√ÅRIO (‚ÄúPPA-PADR√ÉO‚Äù)¬Æ</b>`
    : `‚ÄúESPINGARDA CAL 12‚Äù<br><b>S√öMULA PARA HABILITAR USU√ÅRIO (‚ÄúPPA-PADR√ÉO‚Äù)¬Æ</b>`;

  // ===== A (alvos) =====
  const tiros = Array.isArray(c.tiros) ? c.tiros : [];
  let rowsA = "";
  for(let i=0;i<22;i++){
    if(obj.tipo==="PPA_PISTOLA"){
      const v1 = Number(tiros[i*2]   ?? 0);
      const v2 = Number(tiros[i*2+1] ?? 0);
      rowsA += `<tr>
        <td style="text-align:center">${String(i+1).padStart(2,"0")}</td>
        <td style="text-align:center">${v1}</td>
        <td style="text-align:center">${v2}</td>
        <td style="text-align:center"><b>${v1+v2}</b></td>
      </tr>`;
    }else{
      const v = Number(tiros[i] ?? 0);
      rowsA += `<tr>
        <td style="text-align:center">${String(i+1).padStart(2,"0")}</td>
        <td style="text-align:center"><b>${v}</b></td>
      </tr>`;
    }
  }

  const headA = (obj.tipo==="PPA_PISTOLA")
    ? `<tr><th>ALVO</th><th>TIRO 1</th><th>TIRO 2</th><th>SUBTOTAL</th></tr>`
    : `<tr><th>ALVO</th><th>PONTOS</th></tr>`;

  const zonaTxt = (obj.tipo==="PPA_PISTOLA")
    ? `‚ÄúA‚Äù, ‚ÄúB‚Äù, ‚ÄúC‚Äù, ‚ÄúD‚Äù, bra√ßo e m√£o que segura a arma; acerto na arma do agressor: 10 (dez) pontos<br>‚ÄúE‚Äù, ‚ÄúF‚Äù, ‚ÄúG‚Äù, ‚ÄúH‚Äù: 05 (cinco) pontos`
    : `‚ÄúA‚Äù, ‚ÄúB‚Äù, ‚ÄúC‚Äù, ‚ÄúD‚Äù, bra√ßo e m√£o que segura a arma; acerto na arma do agressor: 20 (vinte) pontos<br>‚ÄúE‚Äù, ‚ÄúF‚Äù, ‚ÄúG‚Äù, ‚ÄúH‚Äù: 10 (dez) pontos`;

  // ===== B (procedimentos) =====
  const procOK = Array.isArray(c.procedimentosOK) ? c.procedimentosOK : Array(rule.procCount).fill(true);
  let rowsB = "";
  for(let i=0;i<rule.procCount;i++){
    const ok = (procOK[i] ?? true);
    rowsB += `<tr>
      <td style="width:42px;text-align:center">${String(i+1).padStart(2,"0")}</td>
      <td>${escHtml(T.proc[i]||"")}</td>
      <td style="text-align:center;font-weight:900">${ok ? "X" : ""}</td>
      <td style="text-align:center;font-weight:900">${!ok ? "X" : ""}</td>
    </tr>`;
  }

  // ===== C (penalidades) =====
  const qtd = c.penalidadesQtd || {};
  let rowsC = "";
  let penCount = 0;
  for(let i=0;i<(T.pen||[]).length;i++){
    const n = Number(qtd[i]||0);
    penCount += n;
    rowsC += `<tr>
      <td style="width:42px;text-align:center">${String(i+1).padStart(2,"0")}</td>
      <td>${escHtml(T.pen[i]||"")}</td>
      <td style="width:70px;text-align:center">${n>0?("x"+n):"‚Äî"}</td>
      <td style="width:70px;text-align:center">${n>0?(n*rule.penPts):"0"}</td>
    </tr>`;
  }

  // ===== D (reprova√ß√£o) =====
  const rep = Array.isArray(c.reprovacao) ? c.reprovacao : [];
  let rowsD="";
  for(let i=0;i<(T.rep||[]).length;i++){
    const mark = !!rep[i];
    rowsD += `<tr>
      <td style="width:42px;text-align:center">${String(i+1).padStart(2,"0")}</td>
      <td>${escHtml(T.rep[i]||"")}</td>
      <td style="width:70px;text-align:center;font-weight:900">${mark?"X":""}</td>
    </tr>`;
  }

  const A = Number(c.A ?? (tiros||[]).reduce((s,v)=>s+Number(v||0),0));
  const B = Number(c.B ?? ((procOK||[]).filter(Boolean).length * (rule.procPts||10)));
  const Ctot = Number(c.C ?? (penCount * (rule.penPts||10)));
  const E = Number(c.E ?? (A + B - Ctot));
  const nota = (c.nota!=null) ? Number(c.nota) : Number(Math.max(0, Math.min(rule.max, E)).toFixed(3));
  const conc = c.conceito || "";

  const conceitoTxt = `
    De 00 % √† 49 % da pontua√ß√£o m√°xima poss√≠vel (de ________ a _______ pts): <b>Insuficiente</b><br>
    De 50 % √† 69 % da pontua√ß√£o m√°xima poss√≠vel (de ________ a _______ pts): <b>Regular</b><br>
    De 70 % √† 84 % da pontua√ß√£o m√°xima poss√≠vel (de ________ a _______ pts): <b>Bom</b><br>
    De 85 % √† 95 % da pontua√ß√£o m√°xima poss√≠vel (de ________ a _______ pts): <b>Muito bom</b> (PASSAR PARA O CABE√áALHO)<br>
    De 96 % √† 100 % da pontua√ß√£o m√°xima poss√≠vel (de ________ a _______ pts): <b>Excepcional</b>
  `;

  const sigImg = (sig && sig.dataUrl) ? `<img src="${sig.dataUrl}" alt="Assinatura">` : "";

  return `
  <div class="sumula">
    <div class="page">
      <div class="s-title">${tituloTopo}</div>
      <div class="s-sub">${armaTitulo}</div>

      <table class="s-table" style="margin-top:10px">
        <tr>
          <td><b>DATA</b> ${escHtml(obj.data||"")}</td>
          <td><b>LOCAL</b> ${escHtml(obj.local||"")}</td>
        </tr>
        <tr><td colspan="2"><b>NOME</b> ${escHtml(a.nome||"")}</td></tr>
        <tr>
          <td><b>RE</b> ${escHtml(a.re||"")}</td>
          <td><b>POST/GRAD</b> ${escHtml(a.postoGrad||"")}</td>
        </tr>
        <tr><td colspan="2"><b>UNIDADE</b> ${escHtml(obj.unidade||"")}</td></tr>
        <tr>
          <td><b>${obj.tipo==="PPA_PISTOLA" ? "PISTOLA N¬∫" : "ESPINGARDA N¬∫"}</b> ${escHtml(a.armaNumero||"")}</td>
          <td><b>STATUS</b> ${escHtml(obj.status||"")}</td>
        </tr>
      </table>

      <table class="s-table" style="margin-top:10px">
        <tr>
          <th>PONTUA√á√ÉO M√ÅXIMA POSS√çVEL</th><th>PONTUA√á√ÉO OBTIDA (E)</th><th>CONCEITO</th><th>NOTA</th>
        </tr>
        <tr>
          <td style="text-align:center"><b>${rule.max}</b></td>
          <td style="text-align:center"><b>${E}</b></td>
          <td style="text-align:center"><b>${escHtml(conc)}</b></td>
          <td style="text-align:center"><b>${Number(nota).toFixed(3)}</b></td>
        </tr>
      </table>

      <div style="margin-top:10px;font-size:12px">
        <b>‚ÄúA‚Äù ‚Äì PONTOS NOS ALVOS</b> ‚Äî ${obj.tipo==="PPA_PISTOLA" ? "Dois disparos em cada alvo atir√°vel." : "Cartucho ‚ÄúSingular‚Äù (proj√©til √∫nico) ‚Äì 1 disparo em cada alvo atir√°vel."}
      </div>

      <table class="s-table">
        ${headA}
        ${rowsA}
        <tr>
          <td colspan="${obj.tipo==="PPA_PISTOLA" ? 3 : 1}" style="text-align:right"><b>TOTAL A</b></td>
          <td style="text-align:center"><b>${A}</b></td>
        </tr>
      </table>

      <table class="s-table" style="margin-top:10px">
        <tr><th>VALORES DAS ZONAS DE PONTUA√á√ÉO</th></tr>
        <tr><td style="font-size:11px">${zonaTxt}</td></tr>
      </table>

      <table class="s-table" style="margin-top:10px">
        <tr><th colspan="4">‚ÄúB‚Äù ‚Äì PONTOS DOS PROCEDIMENTOS (10 pts positivos por procedimento certo)</th></tr>
        <tr><th style="width:42px">N¬∫</th><th>PROCEDIMENTO (descri√ß√£o)</th><th style="width:70px">CERTO</th><th style="width:70px">ERRADO</th></tr>
        ${rowsB}
        <tr>
          <td colspan="2" style="text-align:right"><b>TOTAL B</b></td>
          <td colspan="2" style="text-align:center"><b>${B}</b></td>
        </tr>
      </table>
    </div>

    <div class="page">
      <table class="s-table">
        <tr><th colspan="4">‚ÄúC‚Äù ‚Äì PENALIDADES (10 pts negativos por ocorr√™ncia)</th></tr>
        <tr><th style="width:42px">N¬∫</th><th>PENALIDADE (descri√ß√£o)</th><th style="width:70px">QTD</th><th style="width:70px">PTS</th></tr>
        ${rowsC}
        <tr>
          <td colspan="3" style="text-align:right"><b>TOTAL C</b></td>
          <td style="text-align:center"><b>${Ctot}</b></td>
        </tr>
      </table>

      <table class="s-table" style="margin-top:10px">
        <tr><th colspan="3">‚ÄúD‚Äù ‚Äì REPROVA√á√ÉO (penalidades fatais)</th></tr>
        <tr><th style="width:42px">N¬∫</th><th>REPROVA√á√ÉO (descri√ß√£o)</th><th style="width:70px">MARCA</th></tr>
        ${rowsD}
      </table>

      <table class="s-table" style="margin-top:10px">
        <tr><th colspan="2">‚ÄúE‚Äù ‚Äì PONTUA√á√ÉO FINAL (A + B ‚àí C)</th></tr>
        <tr><td><b>A</b> ${A}</td><td><b>B</b> ${B}</td></tr>
        <tr><td><b>C</b> ${Ctot}</td><td><b>E</b> <b>${E}</b></td></tr>
      </table>

      <table class="s-table" style="margin-top:10px">
        <tr><th>‚ÄúF‚Äù ‚Äì CONCEITOS/NOTA</th></tr>
        <tr><td style="font-size:11px;line-height:1.3">${conceitoTxt}</td></tr>
      </table>

      <table class="s-table" style="margin-top:10px">
        <tr><th colspan="2">Observa√ß√µes</th></tr>
        <tr><td style="width:20%"><b>Aluno</b></td><td>${escHtml(obj.obsAluno||"")}</td></tr>
        <tr><td><b>Instrutor</b></td><td>${escHtml(c.obsInstr||"")}</td></tr>
      </table>

      <div class="sig">
        <div class="block">
          <div class="line"><b>Assinatura do Aluno</b> ‚Äî Posto/Grad, RE, nome de guerra leg√≠vel</div>
          <div class="line"><b>Assinatura do Professor</b></div>
          <div style="margin-top:10px;font-size:11px">Anexar esta s√∫mula ao ‚ÄúRIT‚Äù do aluno ‚Ä¢ OBS.: Anota√ß√µes no verso</div>
        </div>
        ${sigImg ? `<div>${sigImg}</div>` : ``}
      </div>
    </div>
  </div>`;
}

async function openSumulaModal(id, obj){
  const sig = await fetchAssinatura();
  $("modalSub").textContent = `ID ${id} ‚Ä¢ ${obj.aluno1?.nome||"-"} ‚Ä¢ ${obj.tipo||"-"} ‚Ä¢ ${obj.data||"-"}`;
  $("modalBody").innerHTML = renderSumulaHTML(id, obj, sig);
  $("btnPrint").style.display = isDesktop() ? "" : "none";
  $("modal").style.display="flex";
}

function closeModal(){
  $("modal").style.display="none";
  $("modalBody").innerHTML="";
}

function doPrintCurrentModal(){
  const html = $("modalBody").innerHTML;
  $("printArea").innerHTML = html;
  $("printArea").style.display = "block";
  window.print();
  $("printArea").style.display = "none";
  $("printArea").innerHTML = "";
}

/*************** CONSULTA ***************/
async function consultarRE(){
  const re=safe($("consultaRE").value);
  if(!re) return alert("Digite um RE.");
  $("consultaList").innerHTML = `<div class="muted">Consultando‚Ä¶</div>`;
  try{
    const idx = await rtdbGet(`indexPorRE/${encodeURIComponent(re)}`);
    if(!idx){ $("consultaList").innerHTML=`<div class="muted">Nenhum registro para esse RE.</div>`; return; }

    const ids = Object.keys(idx);
    const reads = await Promise.all(ids.map(id => rtdbGet(`avaliacoes/${id}`)));
    const items = reads.map((v,i)=> ({id:ids[i], ...v}))
      .filter(x=>x && x.tipo)
      .sort((a,b)=> (b.criadoEm||"").localeCompare(a.criadoEm||""));

    $("consultaList").innerHTML="";
    for(const it of items){
      const nome = it.aluno1?.nome || "(sem nome)";
      const tipo = it.tipo || "-";
      const data = it.data || "-";
      const st = it.status || "-";
      const E = it.correcao?.E ?? 0;
      const conc = it.correcao?.conceito ?? "-";

      const div=document.createElement("div");
      div.className="item";
      div.innerHTML = `
        <div>
          <div><b>${nome}</b> ‚Ä¢ ${tipo}</div>
          <div class="muted">${data} ‚Ä¢ <span style="color:${st==='FINALIZADO'?'#16d468':'#ffd36a'}">${st}</span></div>
        </div>
        <div class="right">
          <span class="pill2">Pts: ${it.correcao?.pontos ?? Math.max(0, Math.min(350, Number(E||0)))}</span><span class="pill2">Nota: ${Number(it.correcao?.nota ?? ((Math.max(0, Math.min(350, Number(E||0))) / 350) * 10)).toFixed(3)}</span>
          <span class="pill2">${conc}</span>
          <button class="tiny primary" data-id="${it.id}">Ver</button>
        </div>`;
      div.querySelector("button").addEventListener("click", ()=> openSumulaModal(it.id, it));
      $("consultaList").appendChild(div);
    }
  }catch(e){
    console.error(e);
    $("consultaList").innerHTML = `<div class="muted">Erro: permiss√µes (Rules) ou conex√£o.</div>`;
  }
}

/*************** INIT ***************/
async function init(){
  try{ await rtdbGet("config"); setBadge("ONLINE (RTDB)", true); }
  catch(e){ console.error(e); setBadge("OFFLINE / RULES BLOQUEANDO", false); }
}

window.addEventListener("DOMContentLoaded", ()=>{
  init();
  $("btnConsultar").addEventListener("click", consultarRE);
  $("consultaRE").addEventListener("keydown", (e)=>{ if(e.key==="Enter") consultarRE(); });

  $("btnCloseModal").addEventListener("click", closeModal);
  $("btnPrint").addEventListener("click", doPrintCurrentModal);
  $("modal").addEventListener("click", (e)=>{ if(e.target===$("modal")) closeModal(); });
});
</script>
</body>
</html>
