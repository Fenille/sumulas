<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>RITE ‚Ä¢ S√∫mulas de Tiro</title>
<style>
:root{
  --y:#ffff00; --yn:#f9ff7a;
  --bg:#000; --bg2:#050509;
  --card:rgba(10,10,15,.96);
  --bd:rgba(255,255,0,.18);
  --mut:#cfcfcf;
  --sh:0 14px 40px rgba(0,0,0,.85);
  --r:18px;
}
*{box-sizing:border-box}
body{
  margin:0; min-height:100vh;
  font-family:Arial,Helvetica,sans-serif;
  color:var(--y);
  background:radial-gradient(circle at top,#202020 0,var(--bg2) 52%,var(--bg) 100%);
}
.wrap{max-width:1200px;margin:0 auto;padding:16px}
.top{
  display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;
  padding:14px 16px;border:1px solid var(--bd);border-radius:18px;
  background:linear-gradient(180deg,rgba(10,10,15,.96),rgba(5,5,9,.92));
  box-shadow:var(--sh);
}
h1{margin:0;font-size:18px;letter-spacing:.6px}
.sub{color:var(--mut);font-size:12px;margin-top:4px;line-height:1.35}
.badge{
  padding:8px 10px;border-radius:999px;font-weight:900;font-size:12px;white-space:nowrap;
  background:rgba(255,255,0,.16);color:var(--y);border:1px solid rgba(255,255,0,.25)
}
.badge.ok{background:var(--y);color:#0b0b10;border:1px solid rgba(0,0,0,.2)}
.grid{display:grid;grid-template-columns:1fr;gap:14px;margin-top:14px}
@media(min-width:920px){.grid{grid-template-columns:420px 1fr}}
.card{
  background:var(--card);
  border:1px solid var(--bd);
  border-radius:18px;
  box-shadow:var(--sh);
  padding:14px;
}
.pill{
  display:inline-flex;gap:8px;align-items:center;
  padding:6px 10px;border-radius:999px;
  border:1px solid rgba(255,255,0,.22);
  background:rgba(0,0,0,.25);
  font-size:12px;color:var(--mut);
}
.sep{height:1px;background:rgba(255,255,0,.14);margin:12px 0}
.row{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
.field{grid-column:span 12;display:flex;flex-direction:column;gap:6px}
.field label{font-size:12px;color:var(--mut)}
input,select,textarea{
  width:100%; border-radius:12px;
  border:1px solid rgba(255,255,0,.22);
  background:rgba(0,0,0,.35);
  color:var(--y);
  padding:10px 12px; outline:none;
}
/* FIX: valor selecionado vis√≠vel (Chrome/Android) */
select{ -webkit-text-fill-color: var(--y); }
option{ color:#0b0b10; background:var(--y); }
textarea{min-height:86px;resize:vertical}
.btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
button{
  border:0;border-radius:14px;padding:10px 14px;
  font-weight:900;cursor:pointer;
  background:rgba(255,255,0,.14);color:var(--y);
  border:1px solid rgba(255,255,0,.28);
}
button.primary{background:var(--y);color:#0b0b10;border:1px solid rgba(0,0,0,.2)}
button.danger{background:rgba(255,60,60,.14);border-color:rgba(255,60,60,.35);color:#ffd3d3}
.muted{color:var(--mut);font-size:12px;line-height:1.35}
.list{display:grid;gap:10px}
.item{
  padding:12px;border-radius:16px;
  border:1px solid rgba(255,255,0,.18);
  background:rgba(0,0,0,.25);
  display:flex;justify-content:space-between;gap:10px;align-items:flex-start;
}
.item b{color:var(--y)}
.right{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
.kpi{display:flex;gap:10px;flex-wrap:wrap}
.kpi .pill{color:var(--yn)}
.tabs{display:flex;gap:10px;flex-wrap:wrap}
.tiny{padding:7px 10px;border-radius:12px;font-size:12px}
.shotsGrid{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:8px}
@media(min-width:920px){.shotsGrid{grid-template-columns:repeat(10,minmax(0,1fr));}}
.shotCell{
  border:1px solid rgba(255,255,0,.18);
  background:rgba(0,0,0,.25);
  border-radius:12px;
  padding:8px;
  display:flex;flex-direction:column;gap:6px;
}
.shotCell label{font-size:11px;color:var(--mut)}
.shotCell select{padding:8px 10px;border-radius:10px}
.checks{display:grid;grid-template-columns:1fr;gap:8px}
@media(min-width:920px){.checks{grid-template-columns:1fr 1fr}}
.checkItem{
  display:flex;gap:10px;align-items:flex-start;
  padding:10px 12px;border-radius:14px;
  border:1px solid rgba(255,255,0,.16);
  background:rgba(0,0,0,.22);
}
.checkItem input{width:auto;margin-top:3px}
.checkItem .txt{display:flex;flex-direction:column;gap:4px}
.checkItem .txt b{font-size:13px}
.checkItem .txt small{color:var(--mut);font-size:12px;line-height:1.25}
.imgPrev{max-width:360px;width:100%;border-radius:14px;border:1px solid rgba(255,255,0,.22);background:rgba(0,0,0,.25);padding:10px}
/* mobile-first para inser√ß√£o */
@media(max-width:560px){
  .wrap{padding:12px}
  button{width:100%}
  .btns{gap:8px}
  .row{gap:8px}
}
    /* FIX: texto do select vis√≠vel no Chrome mobile/dark */
    .shotCell select{
      color: var(--y) !important;
      -webkit-text-fill-color: var(--y) !important;
      background: rgba(0,0,0,.55) !important;
      font-weight: 900;
      text-align: center;
    }
    .shotCell select option{
      background: #0b0b10;
      color: #ffff00;
    }
    .shotVal{
      margin-top: 6px;
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,0,.18);
      background: rgba(0,0,0,.35);
      text-align: center;
      font-weight: 900;
      color: var(--yn);
      letter-spacing: .5px;
      font-size: 13px;
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div>
      <h1>RITE ‚Ä¢ S√∫mulas de Tiro</h1>
      <div class="sub">Mobile-first ‚Ä¢ Aluno: s√≥ cabe√ßalho (RE puxa cadastro) ‚Ä¢ Instrutor: tiros 1 a 1 + procedimentos + penalidades + reprova√ß√£o ‚Ä¢ Nota 0‚Äì10 (3 casas) ‚Ä¢ Consulta por RE (dossi√™) ‚Ä¢ S√∫mula no padr√£o (2 p√°ginas A4)</div>
    </div>
    <div id="badge" class="badge">OFFLINE</div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="pill">üîê Login</div>
      <div class="sep"></div>

      <div class="row">
        <div class="field">
          <label>Usu√°rio (RE do aluno OU Fenille)</label>
          <input id="loginUser" placeholder="Ex.: 123456-7 ou Fenille">
        </div>
        <div class="field">
          <label>Senha</label>
          <input id="loginPass" type="password" placeholder="Senha">
        </div>
      </div>
      <div class="btns">
        <button class="primary" id="btnLogin">Entrar</button>
        <button id="btnDemoAluno">Demo Aluno</button>
        <button id="btnDemoInstr">Demo Instrutor</button>
      </div>

      <div class="sep"></div>

      <div class="pill">üîé Consulta por RE (Dossi√™)</div>
      <div class="muted" style="margin-top:8px">Mostra todas as avalia√ß√µes do RE e permite abrir e imprimir a s√∫mula.</div>
      <div class="row" style="margin-top:10px">
        <div class="field" style="grid-column:span 8">
          <label>RE</label>
          <input id="consultaRE" placeholder="Ex.: 123456-7">
        </div>
        <div class="field" style="grid-column:span 4;align-self:end">
          <button class="primary" id="btnConsultar">Consultar</button>
        </div>
      </div>

      <div class="sep"></div>
      <div class="list" id="consultaList"></div>

      <div class="sep"></div>
      <div class="muted">
        Aluno: senha padr√£o <b>1234</b><br>
        Instrutor: <b>Fenille</b> / <b>140965</b>
      </div>
    </div>

    <div class="card" id="appCard" style="display:none;">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;">
        <div>
          <div class="pill" id="whoPill">üë§</div>
          <div class="muted" id="whoSub"></div>
        </div>
        <div class="tabs">
          <button id="tabAluno" style="display:none;">Tela do Aluno</button>
          <button id="tabInstr" style="display:none;">Painel do Instrutor</button>
          <button id="tabSig" style="display:none;">Assinatura</button>
          <button class="danger" id="btnLogout">Sair</button>
        </div>
      </div>

      <div class="sep"></div>

      <div id="viewAluno" style="display:none;">
        <div class="pill">üìù Cabe√ßalho (Aluno)</div>
        <div class="muted" style="margin-top:8px">Digite o RE ‚Üí o sistema tenta puxar o cadastro. Se n√£o existir, voc√™ cadastra 1¬™ vez. Depois, o nome fica travado no RE.</div>
        <div class="sep"></div>

        <div class="row">
          <div class="field" style="grid-column:span 6">
            <label>Tipo</label>
            <select id="tipo">
              <option value="PPA_PISTOLA">PPA ‚Ä¢ Pistola .40</option>
              <option value="PPA_ESP12">PPA ‚Ä¢ Espingarda 12</option>
            </select>
          </div>
          <div class="field" style="grid-column:span 6">
            <label>Data</label>
            <input id="data" type="date">
          </div>

          <div class="field" style="grid-column:span 6">
            <label>Local</label>
            <input id="local" placeholder="Estande / Localidade">
          </div>
          <div class="field" style="grid-column:span 6">
            <label>Unidade</label>
            <input id="unidade" placeholder="18¬∫ BPM/I">
          </div>

          <div class="field" style="grid-column:span 3">
            <label>RE</label>
            <input id="aRE" placeholder="RE">
          </div>
          <div class="field" style="grid-column:span 9">
            <label>Nome (puxado pelo RE)</label>
            <input id="aNome" placeholder="Nome completo">
          </div>

          <div class="field" style="grid-column:span 6">
            <label>Posto/Grad</label>
            <input id="aPG" placeholder="Sd PM">
          </div>

          <div class="field" style="grid-column:span 6">
            <label>N¬∫ da arma</label>
            <input id="aArma" placeholder="12345">
          </div>

          <div class="field">
            <label>Observa√ß√µes (opcional)</label>
            <textarea id="obsAluno" placeholder="..."></textarea>
          </div>
        </div>

        <div class="btns">
          <button class="primary" id="btnEnviar">Enviar para o instrutor</button>
        </div>

        <div class="sep"></div>
        <div class="muted" id="alunoMsg"></div>
      </div>

      <div id="viewInstr" style="display:none;">
        <div class="pill">üßë‚Äçüè´ Painel do Instrutor</div>
        <div class="muted" style="margin-top:8px">Carrega as √∫ltimas 50 avalia√ß√µes (leve).</div>

        <div class="sep"></div>
        <div class="kpi">
          <span class="pill" id="kpiTotal">Total: 0</span>
          <span class="pill" id="kpiAguard">Aguardando: 0</span>
          <span class="pill" id="kpiFinal">Finalizados: 0</span>
        </div>

        <div class="sep"></div>
        <div class="list" id="instrList"></div>

        <div class="sep"></div>

        <div id="editor" style="display:none;">
          <div class="pill">‚úçÔ∏è Corre√ß√£o</div>
          <div class="muted" id="edHeader" style="margin-top:8px"></div>

          <div class="sep"></div>

          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;">
            <div class="pill">‚ë† Tiros (1 por 1)</div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="tiny" id="btnZerarTiros">Zerar</button>
              <button class="tiny" id="btnMaxTiros">M√°ximo</button>
            </div>
          </div>
          <div class="muted" id="shotsHelp" style="margin:8px 0 10px 0"></div>
          <div class="shotsGrid" id="shotsGrid"></div>

          <div class="sep"></div>

          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;">
            <div class="pill">‚ë° Procedimentos (25)</div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="tiny" id="btnAllProcOK">Todos corretos</button>
              <button class="tiny" id="btnAllProcErr">Todos errados</button>
            </div>
          </div>
          <div class="muted" style="margin:8px 0 10px 0">Padr√£o: todos corretos. Voc√™ desmarca o que estiver errado.</div>
          <div class="checks" id="procList"></div>

          <div class="sep"></div>

          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;">
            <div class="pill">‚ë¢ Penalidades</div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="tiny" id="btnClearPen">Limpar</button>
            </div>
          </div>
          <div class="muted" style="margin:8px 0 10px 0">Padr√£o: nenhuma marcada.</div>
          <div class="checks" id="penList"></div>

          <div class="sep"></div>

          <div class="pill">‚ë£ Reprova√ß√£o (penalidades fatais)</div>
          <div class="muted" style="margin:8px 0 10px 0">Se marcar qualquer item, o resultado sai como <b>REPROVADO</b> na s√∫mula.</div>
          <div class="checks" id="repList"></div>

          <div class="sep"></div>

          <div class="pill">üìå Resultado autom√°tico</div>
          <div class="row" style="margin-top:10px">
            <div class="field" style="grid-column:span 3">
              <label>A (Tiros)</label>
              <input id="pA" disabled />
            </div>
            <div class="field" style="grid-column:span 3">
              <label>B (Proced.)</label>
              <input id="pB" disabled />
            </div>
            <div class="field" style="grid-column:span 3">
              <label>C (Penal.)</label>
              <input id="pC" disabled />
            </div>
            <div class="field" style="grid-column:span 3">
              <label>E = A + B ‚àí C</label>
              <input id="pE" disabled />
            </div>
            <div class="field" style="grid-column:span 4">
              <label>Nota (0‚Äì10)</label>
              <input id="nota" disabled />
            </div>
            <div class="field" style="grid-column:span 4">
              <label>Conceito</label>
              <input id="conceito" disabled />
            </div>
            <div class="field" style="grid-column:span 4">
              <label>Status</label>
              <input id="statusShow" disabled />
            </div>

            <div class="field">
              <label>Observa√ß√µes do instrutor</label>
              <textarea id="obsInstr" placeholder="..."></textarea>
            </div>
          </div>

          <div class="btns">
            <button class="primary" id="btnSalvar">Salvar</button>
            <button id="btnValidar">VALIDAR</button>
            <button id="btnImprimir">Gerar/Imprimir S√∫mula</button>
            <button id="btnFecharEditor">Fechar</button>
          </div>
        </div>
      </div>

      <div id="viewSig" style="display:none;">
        <div class="pill">üñäÔ∏è Assinatura do Instrutor</div>
        <div class="muted" style="margin-top:8px">Upload PNG/JPG ‚Üí salva em <b>config/instrutores/Fenille/assinatura</b></div>
        <div class="sep"></div>

        <div class="row">
          <div class="field" style="grid-column:span 6">
            <label>Arquivo (PNG/JPG)</label>
            <input id="sigFile" type="file" accept="image/png,image/jpeg"/>
          </div>
          <div class="field" style="grid-column:span 6">
            <label>Nome exibido</label>
            <input id="sigNome" placeholder="CAP PM 140965-4 FENILLE"/>
          </div>
        </div>

        <div class="btns">
          <button class="primary" id="btnSalvarSig">Salvar assinatura</button>
          <button class="danger" id="btnApagarSig">Apagar assinatura</button>
        </div>

        <div class="sep"></div>

        <div class="row">
          <div class="field" style="grid-column:span 6">
            <label>Pr√©via</label>
            <div class="imgPrev">
              <img id="sigPreview" style="max-width:100%;height:auto;display:none"/>
              <div id="sigEmpty" class="muted">Nenhuma assinatura salva.</div>
            </div>
          </div>
          <div class="field" style="grid-column:span 6">
            <label>Info</label>
            <textarea id="sigInfo" readonly></textarea>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
/*************** CONFIG ***************/
const DATABASE_URL = "https://rite-fa75b-default-rtdb.firebaseio.com";
const INSTRUTOR_USER = "Fenille";
const INSTRUTOR_PASS = "140965";
const ALUNO_PASS = "1234";

/*************** REGRAS ***************/
const RULES = {
  PPA_PISTOLA: { max: 350, shots: 44, shotOptions: [0,5,10], procCount: 25, procPts: 10, penPts: 10 },
  PPA_ESP12:   { max: 350, shots: 22, shotOptions: [0,10,20], procCount: 25, procPts: 10, penPts: 10 },
};
const PROC_DESC = ["Mediante ordem preparar a pistola para executar a ‚ÄúPPA‚Äù colocando-a no coldre (alimentada, carregada, c√£o desarmado, travada, coldre abotoado). Primeiro carregador com 6 (seis) cartuchos; um carregador de reposi√ß√£o com 10 (dez) cartuchos.", "Ao sinal convencionado sacar a pistola e colocar-se em prote√ß√£o no abrigo ‚ÄùA‚Äù, com rapidez, em condi√ß√µes de atuar e disparar", "Varredura e sa√≠da do abrigo ‚ÄúA‚Äù", "Primeira progress√£o (do abrigo ‚ÄúA‚Äù at√© o abrigo ‚ÄúB‚Äù)", "Proteger-se e atuar corretamente no abrigo ‚ÄúB‚Äù e progress√£o at√© o abrigo ‚ÄúC‚Äù", "Proteger-se e atuar corretamente no abrigo ‚ÄúC‚Äù e progress√£o at√© o abrigo ‚ÄúD‚Äù", "Proteger-se e atuar corretamente na ‚Äújanela baixa‚Äù (abrigo ‚ÄúD‚Äù)", "Proteger-se e atuar corretamente no canto da direita (abrigo ‚ÄúD)", "Primeira verbaliza√ß√£o obrigat√≥ria, com posi√ß√£o correta da arma (abrigo ‚ÄúD‚Äù)", "Proteger-se e atuar corretamente na ‚Äújanela alta‚Äù (abrigo ‚ÄúD‚Äù)", "Proteger-se e atuar corretamente no canto da esquerda (abrigo ‚ÄúD‚Äù)", "Segunda verbaliza√ß√£o obrigat√≥ria, com posi√ß√£o correta da arma (abrigo ‚ÄúD‚Äù)", "Terceira verbaliza√ß√£o obrigat√≥ria, com posi√ß√£o correta da arma (abrigo ‚ÄúD‚Äù)", "Recarregar a pistola corretamente, com rapidez, protegido, e sem perder o contato visual com a √°rea de perigo (recarga t√°tica ou emergencial, a crit√©rio do aluno).", "Atuar com a pistola sempre carregada", "Efetuar os disparos com rapidez (dois de cada vez em cada alvo atir√°vel).", "Conduzir a pistola corretamente, com o cano e o olhar na dire√ß√£o do perigo.", "Dedo fora do gatilho quando dos deslocamentos, e quando n√£o for para atirar", "Outras verbaliza√ß√µes, com posi√ß√£o correta da arma.", "Aplica√ß√£o de sinais policiais, em situa√ß√µes obrigat√≥rias, como se estivesse com um companheiro", "Proteger-se corretamente nos demais procedimentos.", "Regress√£o (do abrigo ‚ÄúD‚Äù at√© o abrigo ‚ÄúA‚Äù)", "Terminada a regress√£o coldrear a pistola, em seguran√ßa, sem descarreg√°-la, travada. Aguardar ordens", "Mediante ordem retirar a pistola do coldre, descarreg√°-la, com seguran√ßa, entregando-a ao professor como se a estivesse entregando na reserva de armas ou a outro companheiro", "Solu√ß√£o de incidentes de tiro (caso ocorram)"];
const PEN_DESC  = ["Arma e equipamentos mal ajustados ao corpo atrapalhando a execu√ß√£o dos exerc√≠cios.", "Disparo, sem acerto, em alvo n√£o atir√°vel. Cada disparo uma penalidade. Ver item seguinte", "Acerto em alvo n√£o atir√°vel. Cada acerto duas penalidades. Ver item anterior (um n√£o exclui o outro)", "Disparos no mesmo alvo, al√©m do determinado (cada disparo a mais uma penalidade)", "Deixar de disparar contra alvo agressor obrigatoriamente atir√°vel (cada disparo uma penalidade).", "N√£o manter a arma em ‚Äúposi√ß√£o de tiro‚Äù, efetuando ‚Äúvarredura‚Äù, ap√≥s os disparos", "Derrubar o carregador de reposi√ß√£o", "Acionar o gatilho estando a pistola travada ou descarregada.", "Ultrapassar a arma, ou qualquer parte do corpo, para al√©m da zona de seguran√ßa.", "N√£o completar a pista por falta de muni√ß√£o (uma penalidade para cada tiro faltante).", "Precipitar-se. Praticar a valentia perigosa. N√£o pedir apoio quando necess√°rio."];
const REP_DESC  = ["Apresentar descontrole emocional", "Atentar contra as normas de seguran√ßa", "Demonstrar dificuldades no manejo ou na atua√ß√£o com a pistola.", "Disparar para fora do barranco de conten√ß√£o dos proj√©teis.", "Disparo acidental com ou sem v√≠tima.", "Derrubar a pistola."];

/*************** ESTADO ***************/
let session = null;   // {role:'aluno'|'instrutor', re? , user?}
let currentId = null;
let currentObj = null;
let sigTempDataUrl = null;

const $ = (id)=>document.getElementById(id);
const isoNow = ()=> new Date().toISOString();
const safe = (s)=> (s??"").toString().trim();
const clamp = (n,a,b)=> Math.max(a, Math.min(b,n));

function setBadge(text, ok){
  const b = $("badge");
  b.textContent = text;
  b.classList.toggle("ok", !!ok);
}

async function rtdbGet(path, query=""){
  const url = `${DATABASE_URL}/${path}.json${query}`;
  const res = await fetch(url, {cache:"no-store"});
  if(!res.ok) throw new Error(await res.text());
  return await res.json();
}
async function rtdbPut(path, data){
  const url = `${DATABASE_URL}/${path}.json`;
  const res = await fetch(url, {method:"PUT", headers:{'Content-Type':'application/json'}, body: JSON.stringify(data)});
  if(!res.ok) throw new Error(await res.text());
  return await res.json();
}
async function rtdbPatch(path, data){
  const url = `${DATABASE_URL}/${path}.json`;
  const res = await fetch(url, {method:"PATCH", headers:{'Content-Type':'application/json'}, body: JSON.stringify(data)});
  if(!res.ok) throw new Error(await res.text());
  return await res.json();
}
async function rtdbPost(path, data){
  const url = `${DATABASE_URL}/${path}.json`;
  const res = await fetch(url, {method:"POST", headers:{'Content-Type':'application/json'}, body: JSON.stringify(data)});
  if(!res.ok) throw new Error(await res.text());
  return await res.json();
}
async function rtdbDelete(path){
  const url = `${DATABASE_URL}/${path}.json`;
  const res = await fetch(url, {method:"DELETE"});
  if(!res.ok) throw new Error(await res.text());
  return true;
}

/*************** CONCEITO (mesma l√≥gica da planilha) ***************/
function conceitoPorPercent(p){
  if (p <= 49) return "Insuficiente";
  if (p <= 69) return "Regular";
  if (p <= 84) return "Bom";
  if (p <= 95) return "Muito bom";
  return "Excepcional";
}
function fmt3(n){ return (Math.round(n*1000)/1000).toFixed(3); }

/*************** ROUTER ***************/
function show(el, yes){ el.style.display = yes ? "" : "none"; }
function openAluno(){ show($("viewAluno"), true); show($("viewInstr"), false); show($("viewSig"), false); }
function openInstr(){ show($("viewAluno"), false); show($("viewInstr"), true); show($("viewSig"), false); loadInstrList(); }
function openSig(){ show($("viewAluno"), false); show($("viewInstr"), false); show($("viewSig"), true); loadSig(); }

function setRoleUI(){
  show($("appCard"), true);

  if(session.role === "aluno"){
    $("whoPill").textContent = "üßë‚ÄçüéØ Aluno";
    $("whoSub").textContent = `RE: ${session.re}`;
    show($("tabAluno"), true);
    show($("tabInstr"), false);
    show($("tabSig"), false);

    $("aRE").value = session.re;
    onREChange(true);
    openAluno();
  } else {
    $("whoPill").textContent = "üßë‚Äçüè´ Instrutor";
    $("whoSub").textContent = `Usu√°rio: ${session.user}`;
    show($("tabAluno"), false);
    show($("tabInstr"), true);
    show($("tabSig"), true);
    openInstr();
  }
}

function logout(){
  session = null;
  currentId = null;
  currentObj = null;
  sigTempDataUrl = null;
  show($("appCard"), false);
  $("loginUser").value = "";
  $("loginPass").value = "";
}

/*************** LOGIN ***************/
function login(){
  const u = safe($("loginUser").value);
  const p = safe($("loginPass").value);
  if(!u || !p) return alert("Preencha usu√°rio e senha.");

  if(u.toLowerCase() === INSTRUTOR_USER.toLowerCase() && p === INSTRUTOR_PASS){
    session = {role:"instrutor", user: INSTRUTOR_USER};
    setRoleUI();
    return;
  }
  if(p !== ALUNO_PASS) return alert("Senha inv√°lida.");
  session = {role:"aluno", re: u};
  setRoleUI();
}

/*************** CADASTRO POR RE ***************/
async function fetchAlunoByRE(re){
  if(!re) return null;
  try{ return await rtdbGet(`alunos/${encodeURIComponent(re)}`); }
  catch(e){ return null; }
}

async function onREChange(silent=false){
  const re = safe($("aRE").value || session?.re || "");
  if(!re) return;
  try{
    const cad = await fetchAlunoByRE(re);
    if(cad && cad.nome){
      $("aNome").value = cad.nome || "";
      $("aPG").value = cad.postoGrad || "";
      $("aNome").disabled = true; // trava nome
      if(!silent) $("alunoMsg").textContent = "‚úÖ Cadastro puxado pelo RE (nome travado).";
    } else {
      $("aNome").disabled = false; // primeiro cadastro
      if(!silent) $("alunoMsg").textContent = "‚ÑπÔ∏è RE sem cadastro. Preencha nome/PG e envie (vai salvar cadastro).";
    }
  }catch(e){ if(!silent) $("alunoMsg").textContent = "Erro ao consultar cadastro (Rules?)."; }
}

/*************** CONSULTA POR RE (DOSSI√ä) ***************/
async function consultarRE(){
  const re = safe($("consultaRE").value);
  if(!re) return alert("Digite um RE.");

  $("consultaList").innerHTML = `<div class="muted">Consultando‚Ä¶</div>`;
  try{
    const idx = await rtdbGet(`indexPorRE/${encodeURIComponent(re)}`);
    if(!idx){ $("consultaList").innerHTML = `<div class="muted">Nenhum registro para esse RE.</div>`; return; }
    const ids = Object.keys(idx);
    const reads = await Promise.all(ids.map(id => rtdbGet(`avaliacoes/${id}`)));
    const items = reads
      .map((v,i)=> (v?{id: ids[i], ...v}:null))
      .filter(Boolean)
      .sort((a,b)=> (b.criadoEm||"").localeCompare(a.criadoEm||""));

    $("consultaList").innerHTML = "";
    for(const it of items){
      const nome = it.aluno1?.nome || "(sem nome)";
      const tipo = it.tipo || "-";
      const data = it.data || "-";
      const st = it.status || "-";
      const E = it.correcao?.E ?? 0;
      const conc = it.correcao?.conceito ?? "-";
      const nota10 = it.correcao?.nota10 ?? 0;

      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div>
          <div><b>${nome}</b> ‚Ä¢ ${tipo}</div>
          <div class="muted">${data} ‚Ä¢ <span style="color:${st==='FINALIZADO'?'#a8ffb0':'#fff0a8'}">${st}</span></div>
          <div class="muted">Nota: <b>${fmt3(Number(nota10)||0)}</b> ‚Ä¢ Conceito: <b>${conc}</b></div>
        </div>
        <div class="right">
          <button class="tiny" data-open="${it.id}">Abrir</button>
          <button class="tiny primary" data-print="${it.id}">Imprimir</button>
        </div>
      `;
      div.querySelector("[data-open]").addEventListener("click", ()=> openDossie(it.id, it));
      div.querySelector("[data-print]").addEventListener("click", ()=> imprimirById(it.id));
      $("consultaList").appendChild(div);
    }
  }catch(e){
    console.error(e);
    $("consultaList").innerHTML = `<div class="muted">Erro: permiss√µes (Rules) ou conex√£o.</div>`;
  }
}

function openDossie(id, it){
  // abre como "banco do aluno": mostra detalhes e bot√µes
  const wrap = document.createElement("div");
  wrap.className = "item";
  wrap.style.flexDirection = "column";
  wrap.innerHTML = `
    <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap">
      <div>
        <div><b>Dossi√™ ‚Ä¢ ID ${id}</b></div>
        <div class="muted">${it.aluno1?.nome||"-"} ‚Ä¢ RE ${it.aluno1?.re||"-"}</div>
        <div class="muted">${it.tipo||"-"} ‚Ä¢ ${it.data||"-"} ‚Ä¢ Status: ${it.status||"-"}</div>
      </div>
      <div class="right">
        <button class="tiny primary" id="dPrint">Imprimir s√∫mula</button>
        <button class="tiny" id="dClose">Fechar</button>
      </div>
    </div>
    <div class="sep"></div>
    <div class="muted"><b>Local:</b> ${it.local||"-"} ‚Ä¢ <b>Unidade:</b> ${it.unidade||"-"} ‚Ä¢ <b>Arma:</b> ${it.aluno1?.armaNumero||"-"}</div>
    <div class="muted"><b>A:</b> ${it.correcao?.A??0} ‚Ä¢ <b>B:</b> ${it.correcao?.B??0} ‚Ä¢ <b>C:</b> ${it.correcao?.C??0} ‚Ä¢ <b>E:</b> ${it.correcao?.E??0}</div>
    <div class="muted"><b>Nota (0‚Äì10):</b> ${fmt3(Number(it.correcao?.nota10)||0)} ‚Ä¢ <b>Conceito:</b> ${it.correcao?.conceito||"-"}</div>
    <div class="muted"><b>Reprova√ß√£o:</b> ${(it.correcao?.reprovacoes||[]).length? "SIM" : "N√ÉO"}</div>
  `;
  $("consultaList").prepend(wrap);
  wrap.querySelector("#dClose").addEventListener("click", ()=> wrap.remove());
  wrap.querySelector("#dPrint").addEventListener("click", ()=> imprimirById(id));
}

async function imprimirById(id){
  const it = await rtdbGet(`avaliacoes/${id}`);
  if(!it) return alert("N√£o encontrado.");
  await imprimir(it, id);
}

/*************** ALUNO: ENVIAR CABE√áALHO ***************/
async function enviarCabecalho(){
  const tipo = $("tipo").value;
  const rule = RULES[tipo];
  if(!rule) return alert("Tipo inv√°lido.");

  const re = safe($("aRE").value) || session.re;
  if(!re) return alert("Informe o RE.");

  // tenta puxar cadastro, se existir trava nome
  const cad = await fetchAlunoByRE(re);
  const nomeDigitado = safe($("aNome").value);
  const nomeFinal = cad?.nome ? cad.nome : nomeDigitado;

  if(cad?.nome && nomeDigitado && nomeDigitado.toLowerCase() !== cad.nome.toLowerCase()){
    return alert("Este RE j√° possui cadastro. O nome n√£o pode ser alterado.");
  }

  const payload = {
    tipo,
    data: $("data").value || "",
    local: safe($("local").value),
    unidade: safe($("unidade").value),
    aluno1: {
      nome: nomeFinal,
      re,
      postoGrad: safe($("aPG").value),
      armaNumero: safe($("aArma").value),
    },
    obsAluno: safe($("obsAluno").value),
    status: "AGUARDANDO_INSTRUTOR",
    criadoEm: isoNow(),
    criadoPor: session.re,
    correcao: {
      tiros: Array(rule.shots).fill(0),
      procedimentosOK: Array(rule.procCount).fill(true),
      penalidadesMarcadas: [],
      reprovacoes: [],
      A: 0,
      B: rule.procCount * rule.procPts,
      C: 0,
      E: 0,
      nota10: 0,
      conceito: "",
      obsInstr: ""
    },
    validadoEm: null,
    validadoPor: null
  };

  if(!payload.data || !payload.local || !payload.unidade || !payload.aluno1.nome || !payload.aluno1.re){
    return alert("Preencha: Data, Local, Unidade, Nome e RE.");
  }

  try{
    // salva cadastro se n√£o existir
    if(!cad){
      await rtdbPut(`alunos/${encodeURIComponent(re)}`, {
        nome: payload.aluno1.nome,
        postoGrad: payload.aluno1.postoGrad,
        criadoEm: isoNow(),
        atualizadoEm: isoNow()
      });
    } else {
      // atualiza PG se vazio no cadastro e veio preenchido
      await rtdbPatch(`alunos/${encodeURIComponent(re)}`, {
        postoGrad: payload.aluno1.postoGrad || cad.postoGrad || "",
        atualizadoEm: isoNow()
      });
    }

    const resp = await rtdbPost("avaliacoes", payload);
    const id = resp?.name;
    if(!id) throw new Error("Push n√£o retornou ID.");

    await rtdbPut(`indexPorRE/${encodeURIComponent(re)}/${id}`, true);

    $("alunoMsg").textContent = `‚úÖ Enviado! ID: ${id}`;
    $("aPG").value = "";
    $("aArma").value = "";
    $("obsAluno").value = "";
    await onREChange(true);
  }catch(e){
    console.error(e);
    alert("Erro ao enviar. Verifique Rules do Firebase.");
  }
}

/*************** INSTRUTOR: LISTA ***************/
async function loadInstrList(){
  $("instrList").innerHTML = `<div class="muted">Carregando‚Ä¶</div>`;
  try{
    const data = await rtdbGet("avaliacoes", `?orderBy="$key"&limitToLast=50`);
    const ids = data ? Object.keys(data) : [];
    const items = ids.map(id => (data[id]?{id, ...data[id]}:null))
      .filter(Boolean)
      .sort((a,b)=> (b.criadoEm||"").localeCompare(a.criadoEm||""));

    let total = items.length, aguard=0, fin=0;
    for(const it of items){ if(it.status === "AGUARDANDO_INSTRUTOR") aguard++; if(it.status === "FINALIZADO") fin++; }
    $("kpiTotal").textContent = `Total: ${total}`;
    $("kpiAguard").textContent = `Aguardando: ${aguard}`;
    $("kpiFinal").textContent = `Finalizados: ${fin}`;

    $("instrList").innerHTML = "";
    for(const it of items){
      const nome = it.aluno1?.nome || "(sem nome)";
      const re = it.aluno1?.re || "-";
      const tipo = it.tipo || "-";
      const dataS = it.data || "-";
      const st = it.status || "-";
      const nota10 = it.correcao?.nota10 ?? 0;

      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div>
          <div><b>${nome}</b> ‚Ä¢ RE ${re}</div>
          <div class="muted">${tipo} ‚Ä¢ ${dataS} ‚Ä¢ <span style="color:${st==='FINALIZADO'?'#a8ffb0':'#fff0a8'}">${st}</span></div>
          <div class="muted">Nota (0‚Äì10): <b>${fmt3(Number(nota10)||0)}</b></div>
        </div>
        <div class="right">
          <button data-id="${it.id}" class="tiny">Abrir</button>
        </div>
      `;
      div.querySelector("button").addEventListener("click", ()=> openEditor(it.id, it));
      $("instrList").appendChild(div);
    }
  }catch(e){
    console.error(e);
    $("instrList").innerHTML = `<div class="muted">Erro: permiss√µes (Rules) ou conex√£o.</div>`;
  }
}

/*************** EDITOR ***************/
function openEditor(id, it){
  currentId = id;
  currentObj = it;

  if(!currentObj.correcao) currentObj.correcao = {};
  const rule = RULES[currentObj.tipo];
  if(!rule){ alert("Tipo n√£o suportado: " + currentObj.tipo); return; }

  if(!Array.isArray(currentObj.correcao.tiros) || currentObj.correcao.tiros.length !== rule.shots){
    currentObj.correcao.tiros = Array(rule.shots).fill(0);
  }
  if(!Array.isArray(currentObj.correcao.procedimentosOK) || currentObj.correcao.procedimentosOK.length !== rule.procCount){
    currentObj.correcao.procedimentosOK = Array(rule.procCount).fill(true);
  }
  if(!Array.isArray(currentObj.correcao.penalidadesMarcadas)) currentObj.correcao.penalidadesMarcadas = [];
  if(!Array.isArray(currentObj.correcao.reprovacoes)) currentObj.correcao.reprovacoes = [];

  $("edHeader").textContent =
    `ID ${id} ‚Ä¢ ${currentObj.tipo} ‚Ä¢ ${currentObj.data||"-"} ‚Ä¢ ${currentObj.aluno1?.nome||"-"} (RE ${currentObj.aluno1?.re||"-"})`;

  $("shotsHelp").textContent =
    currentObj.tipo === "PPA_PISTOLA"
      ? `Pistola: ${rule.shots} tiros ‚Ä¢ valores: ${rule.shotOptions.join(", ")}`
      : `Espingarda 12: ${rule.shots} tiros ‚Ä¢ valores: ${rule.shotOptions.join(", ")}`;

  buildShots(rule);
  buildProcedures(rule);
  buildPenalties(rule);
  buildReprov();

  $("obsInstr").value = currentObj.correcao.obsInstr || "";
  $("statusShow").value = currentObj.status || "-";

  recomputeAll();

  show($("editor"), true);
  window.scrollTo({top:0, behavior:"smooth"});
}

function closeEditor(){
  currentId = null;
  currentObj = null;
  $("shotsGrid").innerHTML = "";
  $("procList").innerHTML = "";
  $("penList").innerHTML = "";
  $("repList").innerHTML = "";
  show($("editor"), false);
}

function buildShots(rule){
      const grid = $("shotsGrid");
      grid.innerHTML = "";

      for(let i=0;i<rule.shots;i++){
        const cell = document.createElement("div");
        cell.className = "shotCell";

        const lab = document.createElement("label");
        lab.textContent = `Tiro ${i+1}`;

        const sel = document.createElement("select");
        for(const v of rule.shotOptions){
          const op = document.createElement("option");
          op.value = String(v);
          op.textContent = String(v);
          sel.appendChild(op);
        }

        sel.value = String(currentObj.correcao.tiros[i] ?? 0);

        // VISOR (garante visualiza√ß√£o do valor selecionado)
        const visor = document.createElement("div");
        visor.className = "shotVal";
        visor.textContent = sel.value;

        sel.addEventListener("change", ()=>{
          currentObj.correcao.tiros[i] = Number(sel.value);
          visor.textContent = sel.value;
          recomputeAll();
        });

        cell.appendChild(lab);
        cell.appendChild(sel);
        cell.appendChild(visor);
        grid.appendChild(cell);
      }
    }

    function buildProcedures(rule){
  const box = $("procList");
  box.innerHTML = "";
  for(let i=0;i<rule.procCount;i++){ 
    const wrap = document.createElement("div");
    wrap.className = "checkItem";
    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.checked = (currentObj.correcao.procedimentosOK[i] ?? true);
    cb.addEventListener("change", ()=>{ currentObj.correcao.procedimentosOK[i] = cb.checked; recomputeAll(); });
    const txt = document.createElement("div");
    txt.className = "txt";
    const desc = (PROC_DESC[i] || `Procedimento ${i+1}`).replaceAll("<","&lt;");
    txt.innerHTML = `<b>${String(i+1).padStart(2,'0')} ‚Ä¢ Procedimento</b><small>${desc}</small>`;
    wrap.appendChild(cb); wrap.appendChild(txt);
    box.appendChild(wrap);
  }
}

function buildPenalties(rule){
  const box = $("penList");
  box.innerHTML = "";
  const marked = new Set(currentObj.correcao.penalidadesMarcadas || []);
  for(let i=0;i<PEN_DESC.length;i++){ 
    const wrap = document.createElement("div");
    wrap.className = "checkItem";
    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.checked = marked.has(i);
    cb.addEventListener("change", ()=>{
      const s = new Set(currentObj.correcao.penalidadesMarcadas || []);
      if(cb.checked) s.add(i); else s.delete(i);
      currentObj.correcao.penalidadesMarcadas = Array.from(s).sort((a,b)=>a-b);
      recomputeAll();
    });
    const txt = document.createElement("div");
    txt.className = "txt";
    const desc = (PEN_DESC[i] || `Penalidade ${i+1}`).replaceAll("<","&lt;");
    txt.innerHTML = `<b>${String(i+1).padStart(2,'0')} ‚Ä¢ Penalidade</b><small>${desc} <span style="opacity:.85">(-${rule.penPts} pts)</span></small>`;
    wrap.appendChild(cb); wrap.appendChild(txt);
    box.appendChild(wrap);
  }
}

function buildReprov(){
  const box = $("repList");
  box.innerHTML = "";
  const marked = new Set(currentObj.correcao.reprovacoes || []);
  for(let i=0;i<REP_DESC.length;i++){ 
    const wrap = document.createElement("div");
    wrap.className = "checkItem";
    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.checked = marked.has(i);
    cb.addEventListener("change", ()=>{
      const s = new Set(currentObj.correcao.reprovacoes || []);
      if(cb.checked) s.add(i); else s.delete(i);
      currentObj.correcao.reprovacoes = Array.from(s).sort((a,b)=>a-b);
      recomputeAll();
    });
    const txt = document.createElement("div");
    txt.className = "txt";
    const desc = (REP_DESC[i] || `Reprova√ß√£o ${i+1}`).replaceAll("<","&lt;");
    txt.innerHTML = `<b>${String(i+1).padStart(2,'0')} ‚Ä¢ Reprova√ß√£o</b><small>${desc}</small>`;
    wrap.appendChild(cb); wrap.appendChild(txt);
    box.appendChild(wrap);
  }
}

function recomputeAll(){
  const rule = RULES[currentObj.tipo];
  const A = (currentObj.correcao.tiros||[]).reduce((s,v)=> s + Number(v||0), 0);
  const okCount = (currentObj.correcao.procedimentosOK||[]).filter(Boolean).length;
  const B = okCount * rule.procPts;
  const penCount = (currentObj.correcao.penalidadesMarcadas||[]).length;
  const C = penCount * rule.penPts;
  const E = A + B - C;

  const pct = rule.max ? (E / rule.max) * 100 : 0;
  const pctC = clamp(pct,0,100);
  const conc = conceitoPorPercent(pctC);

  const nota10 = rule.max ? clamp((E / rule.max) * 10, 0, 10) : 0;

  currentObj.correcao.A = A;
  currentObj.correcao.B = B;
  currentObj.correcao.C = C;
  currentObj.correcao.E = E;
  currentObj.correcao.nota10 = Number(fmt3(nota10));
  currentObj.correcao.conceito = conc;

  $("pA").value = A;
  $("pB").value = B;
  $("pC").value = C;
  $("pE").value = E;
  $("nota").value = fmt3(nota10);
  $("conceito").value = (currentObj.correcao.reprovacoes||[]).length ? "REPROVADO" : conc;
}

async function salvar(validar){
  if(!currentId || !currentObj) return;

  currentObj.correcao.obsInstr = safe($("obsInstr").value);

  const patch = {
    correcao: currentObj.correcao
  };

  if(validar){
    patch.status = "FINALIZADO";
    patch.validadoEm = isoNow();
    patch.validadoPor = session.user;
  } else {
    patch.status = "AGUARDANDO_INSTRUTOR";
  }

  try{
    await rtdbPatch(`avaliacoes/${currentId}`, patch);

    const re = currentObj.aluno1?.re;
    if(re) await rtdbPut(`indexPorRE/${encodeURIComponent(re)}/${currentId}`, true);

    alert(validar ? "‚úÖ Validado." : "‚úÖ Salvo.");
    $("statusShow").value = patch.status;
    currentObj.status = patch.status;
    loadInstrList();
  }catch(e){
    console.error(e);
    alert("Erro ao salvar/validar. Verifique Rules do Firebase.");
  }
}

function zerarTiros(){ const rule = RULES[currentObj.tipo]; currentObj.correcao.tiros = Array(rule.shots).fill(0); buildShots(rule); recomputeAll(); }
function maxTiros(){ const rule = RULES[currentObj.tipo]; const mx = Math.max(...rule.shotOptions); currentObj.correcao.tiros = Array(rule.shots).fill(mx); buildShots(rule); recomputeAll(); }
function allProc(val){ const rule = RULES[currentObj.tipo]; currentObj.correcao.procedimentosOK = Array(rule.procCount).fill(val); buildProcedures(rule); recomputeAll(); }
function clearPen(){ currentObj.correcao.penalidadesMarcadas = []; buildPenalties(RULES[currentObj.tipo]); recomputeAll(); }

/*************** IMPRESS√ÉO (2 p√°ginas A4) ***************/
function esc(s){ return String(s??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }

async function imprimir(it, id){
  // carrega assinatura ANTES de abrir print
  let sig = null;
  try{ sig = await rtdbGet(`config/instrutores/${encodeURIComponent(INSTRUTOR_USER)}/assinatura`); }catch(e){ sig=null; }
  const sigDataUrl = sig?.dataUrl || "";

  const rule = RULES[it.tipo] || {max:350, shots:0, shotOptions:[]};
  const a1 = it.aluno1 || {};
  const c = it.correcao || {};

  const rep = c.reprovacoes || [];
  const isReprov = rep.length>0;

  // listas para marcar
  const procMarks = (c.procedimentosOK||[]).map((ok,i)=>({i, ok}));
  const penMarks = new Set(c.penalidadesMarcadas||[]);

  const tiros = (c.tiros||[]).map(v=>Number(v||0));
  const tirosCols = it.tipo==="PPA_PISTOLA" ? 11 : 11;
  const tirosRows = Math.ceil(tiros.length/tirosCols);
  let tirosTable = "";
  for(let r=0;r<tirosRows;r++) {
    const start = r*tirosCols;
    const slice = tiros.slice(start, start+tirosCols);
    const th = slice.map((_,j)=>`<th>${start+j+1}</th>`).join("");
    const td = slice.map(v=>`<td>${v}</td>`).join("");
    tirosTable += `<tr class="head">${th}</tr><tr>${td}</tr>`;
  }

  const procHtml = procMarks.map(x=> {
    const n = String(x.i+1).padStart(2,'0');
    const d = esc(PROC_DESC[x.i]||"");
    const mark = x.ok ? "X" : "";
    return `<tr><td class="n">${n}</td><td class="d">${d}</td><td class="m">${mark}</td><td class="m">${x.ok?"":"X"}</td></tr>`;
  }).join("");

  const penHtml = PEN_DESC.map((d,i)=> {
    const n = String(i+1).padStart(2,'0');
    const mark = penMarks.has(i) ? "X" : "";
    return `<tr><td class="n">${n}</td><td class="d">${esc(d)}</td><td class="m">${mark}</td></tr>`;
  }).join("");

  const repHtml = REP_DESC.map((d,i)=> {
    const n = String(i+1).padStart(2,'0');
    const mark = rep.includes(i) ? "X" : "";
    return `<tr><td class="n">${n}</td><td class="d">${esc(d)}</td><td class="m">${mark}</td></tr>`;
  }).join("");

  const conceitoFinal = isReprov ? "REPROVADO" : (c.conceito||"-");

  const html = `<!doctype html>
<html><head><meta charset="utf-8"/>
<title>S√∫mula ${esc(it.tipo)} ‚Ä¢ ${esc(a1.re||"")}</title>
<style>
@page{ size:A4; margin:10mm; }
body{ font-family: Arial, Helvetica, sans-serif; color:#111; }
h1{ margin:0; font-size:14px; text-align:center; letter-spacing:.5px; }
.small{ font-size:10px; }
.box{ border:1px solid #000; padding:6px; }
.grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:6px; }
.row{ display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:6px; }
.k{ font-size:10px; }
.v{ font-size:11px; font-weight:700; border-bottom:1px solid #000; padding-bottom:2px; min-height:14px; }
table{ width:100%; border-collapse:collapse; }
td,th{ border:1px solid #000; padding:3px 4px; font-size:9px; vertical-align:top; }
th{ font-weight:700; }
.section{ margin-top:6px; }
.sectionTitle{ font-weight:700; font-size:10px; margin-bottom:3px; }
.n{ width:22px; text-align:center; }
.m{ width:38px; text-align:center; font-weight:700; }
.d{ }
.head th{ background:#f2f2f2; }
.pagebreak{ page-break-after:always; }
.sigbox{ height:48px; border:1px solid #000; display:flex; align-items:center; justify-content:center; }
.sigimg{ max-height:44px; max-width:260px; }
</style>
</head>
<body>
  <h1>S√öMULA DE AVALIA√á√ÉO ‚Äì ${esc(it.tipo)}</h1>
  <div class="small" style="text-align:center;margin-top:2px;">ID ${esc(id)} ‚Ä¢ Gerado em ${new Date().toLocaleString("pt-BR")}</div>

  <div class="section box" style="margin-top:6px;">
    <div class="grid2">
      <div><div class="k">DATA</div><div class="v">${esc(it.data||"")}</div></div>
      <div><div class="k">LOCAL</div><div class="v">${esc(it.local||"")}</div></div>
      <div><div class="k">UNIDADE</div><div class="v">${esc(it.unidade||"")}</div></div>
      <div><div class="k">INSTRUTOR</div><div class="v">${esc(INSTRUTOR_USER)}</div></div>

      <div><div class="k">ALUNO</div><div class="v">${esc(a1.nome||"")}</div></div>
      <div><div class="k">RE</div><div class="v">${esc(a1.re||"")}</div></div>
      <div><div class="k">POSTO/GRAD</div><div class="v">${esc(a1.postoGrad||"")}</div></div>
      <div><div class="k">N¬∫ ARMA</div><div class="v">${esc(a1.armaNumero||"")}</div></div>
    </div>
  </div>

  <div class="section">
    <div class="sectionTitle">‚ÄúA‚Äù ‚Äì DISPAROS (pontua√ß√£o por tiro)</div>
    <div class="box">
      <table>${tirosTable}</table>
    </div>
  </div>

  <div class="section">
    <div class="sectionTitle">‚ÄúB‚Äù ‚Äì PROCEDIMENTOS (CERTO/ERRADO)</div>
    <div class="box">
      <table>
        <tr class="head"><th class="n">#</th><th>Descri√ß√£o</th><th class="m">CERTO</th><th class="m">ERRADO</th></tr>
        ${procHtml}
      </table>
      <div class="small" style="margin-top:4px;"><b>Total B:</b> ${esc(c.B??0)}</div>
    </div>
  </div>

  <div class="pagebreak"></div>

  <div class="section">
    <div class="sectionTitle">‚ÄúC‚Äù ‚Äì PENALIDADES (marcar)</div>
    <div class="box">
      <table>
        <tr class="head"><th class="n">#</th><th>Descri√ß√£o</th><th class="m">MARCAR</th></tr>
        ${penHtml}
      </table>
      <div class="small" style="margin-top:4px;"><b>Total C:</b> ${esc(c.C??0)}</div>
    </div>
  </div>

  <div class="section">
    <div class="sectionTitle">‚ÄúD‚Äù ‚Äì REPROVA√á√ÉO (penalidades fatais)</div>
    <div class="box">
      <table>
        <tr class="head"><th class="n">#</th><th>Descri√ß√£o</th><th class="m">MARCAR</th></tr>
        ${repHtml}
      </table>
      <div class="small" style="margin-top:4px;"><b>Resultado D:</b> ${isReprov ? "REPROVADO" : "N√ÉO"}</div>
    </div>
  </div>

  <div class="section">
    <div class="sectionTitle">‚ÄúE‚Äù ‚Äì PONTUA√á√ÉO FINAL</div>
    <div class="box">
      <table>
        <tr class="head"><th>M√°ximo</th><th>A</th><th>B</th><th>C</th><th>E=A+B-C</th></tr>
        <tr><td>${rule.max}</td><td>${c.A??0}</td><td>${c.B??0}</td><td>${c.C??0}</td><td>${c.E??0}</td></tr>
      </table>
    </div>
  </div>

  <div class="section">
    <div class="sectionTitle">‚ÄúF‚Äù ‚Äì CONCEITO / NOTA</div>
    <div class="box">
      <div class="grid2">
        <div><div class="k">NOTA (0‚Äì10)</div><div class="v">${esc(fmt3(Number(c.nota10)||0))}</div></div>
        <div><div class="k">CONCEITO</div><div class="v">${esc(conceitoFinal)}</div></div>
        <div style="grid-column:1 / -1;">
          <div class="k">OBSERVA√á√ïES DO INSTRUTOR</div>
          <div class="v" style="min-height:28px;">${esc(c.obsInstr||"")}</div>
        </div>
      </div>
    </div>
  </div>

  <div class="section grid2" style="margin-top:10px;">
    <div>
      <div class="k">ASSINATURA DO INSTRUTOR</div>
      <div class="sigbox">
        ${sigDataUrl ? `<img class="sigimg" src="${sigDataUrl}">` : `<span class="small">Sem assinatura cadastrada</span>`}
      </div>
      <div class="small" style="margin-top:3px;">${esc(sig?.nomeExibido || "")}</div>
    </div>
    <div>
      <div class="k">ASSINATURA DO ALUNO</div>
      <div class="sigbox"></div>
    </div>
  </div>
</body></html>`;

  const w = window.open("", "_blank");
  w.document.open();
  w.document.write(html);
  w.document.close();

  // aguarda carregar imagem e ent√£o imprime (sem <script> dentro do HTML)
  const tryPrint = ()=> {
    try{ w.focus(); w.print(); }catch(e){}
  };
  // se tiver assinatura, espera o load da img
  if(sigDataUrl){
    const img = w.document.querySelector("img.sigimg");
    if(img) img.onload = ()=> setTimeout(tryPrint, 150);
    else setTimeout(tryPrint, 250);
  } else {
    setTimeout(tryPrint, 250);
  }
}

/*************** ASSINATURA ***************/
async function loadSig(){
  try{
    const val = await rtdbGet(`config/instrutores/${encodeURIComponent(INSTRUTOR_USER)}/assinatura`);
    if(val?.dataUrl){
      $("sigPreview").src = val.dataUrl;
      $("sigPreview").style.display = "";
      $("sigEmpty").style.display = "none";
      $("sigInfo").value = JSON.stringify({nomeExibido: val.nomeExibido||"", atualizadoEm: val.atualizadoEm||""}, null, 2);
      $("sigNome").value = val.nomeExibido || "";
    }else{
      $("sigPreview").style.display = "none";
      $("sigEmpty").style.display = "";
      $("sigInfo").value = "";
    }
  }catch(e){
    $("sigPreview").style.display = "none";
    $("sigEmpty").style.display = "";
    $("sigInfo").value = "Erro ao ler assinatura (Rules?).";
  }
}

function compressToDataUrl(file, maxW=900, maxH=300, quality=0.85){
  return new Promise((resolve,reject)=>{
    const img = new Image();
    const fr = new FileReader();
    fr.onload = ()=>{
      img.onload = ()=>{
        let w = img.width, h = img.height;
        const ratio = Math.min(maxW/w, maxH/h, 1);
        w = Math.round(w*ratio); h = Math.round(h*ratio);
        const c = document.createElement("canvas");
        c.width = w; c.height = h;
        const ctx = c.getContext("2d");
        ctx.clearRect(0,0,w,h);
        ctx.drawImage(img,0,0,w,h);
        const isPng = file.type === "image/png";
        const dataUrl = isPng ? c.toDataURL("image/png") : c.toDataURL("image/jpeg", quality);
        resolve(dataUrl);
      };
      img.onerror = reject;
      img.src = fr.result;
    };
    fr.onerror = reject;
    fr.readAsDataURL(file);
  });
}

async function onSigFile(){
  const f = $("sigFile").files?.[0];
  if(!f) return;
  sigTempDataUrl = await compressToDataUrl(f);
  $("sigPreview").src = sigTempDataUrl;
  $("sigPreview").style.display = "";
  $("sigEmpty").style.display = "none";
  $("sigInfo").value = JSON.stringify({preview:"ok", bytesAprox: Math.round(sigTempDataUrl.length*0.75)}, null, 2);
}

async function salvarSig(){
  if(!sigTempDataUrl){
    const cur = await rtdbGet(`config/instrutores/${encodeURIComponent(INSTRUTOR_USER)}/assinatura`).catch(()=>null);
    if(!cur?.dataUrl) return alert("Selecione um arquivo de assinatura.");
    sigTempDataUrl = cur.dataUrl;
  }
  const nome = safe($("sigNome").value) || INSTRUTOR_USER;

  const bytes = Math.round(sigTempDataUrl.length * 0.75);
  if(bytes > 250000) return alert("Assinatura muito grande. Use PNG/JPG menor.");

  const payload = { atualizadoEm: isoNow(), dataUrl: sigTempDataUrl, nomeExibido: nome };

  try{
    await rtdbPut(`config/instrutores/${encodeURIComponent(INSTRUTOR_USER)}/assinatura`, payload);
    alert("‚úÖ Assinatura salva.");
    sigTempDataUrl = null;
    $("sigFile").value = "";
    loadSig();
  }catch(e){
    console.error(e);
    alert("Erro ao salvar assinatura (Rules?).");
  }
}

async function apagarSig(){
  if(!confirm("Apagar assinatura salva?")) return;
  try{
    await rtdbDelete(`config/instrutores/${encodeURIComponent(INSTRUTOR_USER)}/assinatura`);
    alert("‚úÖ Apagada.");
    $("sigFile").value = "";
    sigTempDataUrl = null;
    loadSig();
  }catch(e){
    console.error(e);
    alert("Erro ao apagar (Rules?).");
  }
}

/*************** INIT ***************/
async function init(){
  try{
    await rtdbGet("config");
    setBadge("ONLINE (Firebase RTDB)", true);
  }catch(e){
    console.error(e);
    setBadge("OFFLINE / RULES BLOQUEANDO", false);
  }
}

window.addEventListener("DOMContentLoaded", ()=>{
  init();

  $("btnLogin").addEventListener("click", login);
  $("btnLogout").addEventListener("click", logout);

  $("btnDemoAluno").addEventListener("click", ()=>{ $("loginUser").value="123456-7"; $("loginPass").value="1234"; });
  $("btnDemoInstr").addEventListener("click", ()=>{ $("loginUser").value="Fenille"; $("loginPass").value="140965"; });

  $("btnConsultar").addEventListener("click", consultarRE);

  $("tabAluno").addEventListener("click", openAluno);
  $("tabInstr").addEventListener("click", openInstr);
  $("tabSig").addEventListener("click", openSig);

  $("aRE").addEventListener("change", ()=>onREChange(false));
  $("aRE").addEventListener("blur", ()=>onREChange(false));

  $("btnEnviar").addEventListener("click", enviarCabecalho);

  $("btnZerarTiros").addEventListener("click", zerarTiros);
  $("btnMaxTiros").addEventListener("click", maxTiros);
  $("btnAllProcOK").addEventListener("click", ()=>allProc(true));
  $("btnAllProcErr").addEventListener("click", ()=>allProc(false));
  $("btnClearPen").addEventListener("click", clearPen);

  $("btnSalvar").addEventListener("click", ()=>salvar(false));
  $("btnValidar").addEventListener("click", ()=>salvar(true));
  $("btnImprimir").addEventListener("click", ()=> imprimir(currentObj, currentId));
  $("btnFecharEditor").addEventListener("click", closeEditor);

  $("sigFile").addEventListener("change", onSigFile);
  $("btnSalvarSig").addEventListener("click", salvarSig);
  $("btnApagarSig").addEventListener("click", apagarSig);
});
</script>
</body>
</html>
