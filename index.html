<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>RITE ‚Ä¢ S√∫mulas de Tiro</title>
<style>
:root{
  --y:#ffff00; --yn:#f9ff7a; --bg:#000; --bg2:#050509;
  --card:rgba(10,10,15,.96); --bd:rgba(255,255,0,.18);
  --mut:#cfcfcf; --sh:0 14px 40px rgba(0,0,0,.85); --r:18px;
}
*{box-sizing:border-box}
body{margin:0;min-height:100vh;font-family:Arial,Helvetica,sans-serif;color:var(--y);
  background:radial-gradient(circle at top,#202020 0,var(--bg2) 52%,var(--bg) 100%);
}
.wrap{max-width:1200px;margin:0 auto;padding:14px}
.top{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;
  padding:14px 16px;border:1px solid var(--bd);border-radius:18px;
  background:linear-gradient(180deg,rgba(10,10,15,.96),rgba(5,5,9,.92));
  box-shadow:var(--sh);
}
h1{margin:0;font-size:18px;letter-spacing:.6px}
.sub{color:var(--mut);font-size:12px;margin-top:4px}
.badge{padding:8px 10px;border-radius:999px;font-weight:900;font-size:12px;white-space:nowrap;
  background:rgba(255,255,0,.16);color:var(--y);border:1px solid rgba(255,255,0,.25);
}
.badge.ok{background:var(--y);color:#0b0b10;border:1px solid rgba(0,0,0,.2)}
.grid{display:grid;grid-template-columns:1fr;gap:14px;margin-top:14px}
@media(min-width:920px){.grid{grid-template-columns:420px 1fr}}

.card{background:var(--card);border:1px solid var(--bd);border-radius:18px;box-shadow:var(--sh);padding:14px}
.pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;
  border:1px solid rgba(255,255,0,.22);background:rgba(0,0,0,.25);font-size:12px;color:var(--mut);
}
.sep{height:1px;background:rgba(255,255,0,.14);margin:12px 0}
.row{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
.field{grid-column:span 12;display:flex;flex-direction:column;gap:6px}
.field label{font-size:12px;color:var(--mut)}
input,select,textarea{width:100%;border-radius:12px;border:1px solid rgba(255,255,0,.22);
  background:rgba(0,0,0,.35);color:var(--y);padding:10px 12px;outline:none;
}
textarea{min-height:86px;resize:vertical}
select{font-size:14px;line-height:1.2}
select option{color:#111;background:#fff} /* garante leitura ap√≥s selecionar */
.btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
button{border:0;border-radius:14px;padding:10px 14px;font-weight:900;cursor:pointer;
  background:rgba(255,255,0,.14);color:var(--y);border:1px solid rgba(255,255,0,.28);
}
button.primary{background:var(--y);color:#0b0b10;border:1px solid rgba(0,0,0,.2)}
button.danger{background:rgba(255,60,60,.14);border-color:rgba(255,60,60,.35);color:#ffd3d3}
.muted{color:var(--mut);font-size:12px}
.list{display:grid;gap:10px}
.item{padding:12px;border-radius:16px;border:1px solid rgba(255,255,0,.18);background:rgba(0,0,0,.25);
  display:flex;justify-content:space-between;gap:10px;align-items:flex-start;
}
.item b{color:var(--y)}
.right{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
.kpi{display:flex;gap:10px;flex-wrap:wrap}
.kpi .pill{color:var(--yn)}
.tabs{display:flex;gap:10px;flex-wrap:wrap}

.shotsGrid{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:8px}
@media(min-width:920px){.shotsGrid{grid-template-columns:repeat(10,minmax(0,1fr));}}
.shotCell{border:1px solid rgba(255,255,0,.18);background:rgba(0,0,0,.25);border-radius:12px;padding:8px;
  display:flex;flex-direction:column;gap:6px;
}
.shotCell label{font-size:11px;color:var(--mut)}
.shotCell select{padding:10px 10px;border-radius:10px;font-weight:900;text-align:center}

.checks{display:grid;grid-template-columns:1fr;gap:8px}
@media(min-width:920px){.checks{grid-template-columns:1fr 1fr}}
.checkItem{display:flex;gap:10px;align-items:flex-start;padding:10px 12px;border-radius:14px;
  border:1px solid rgba(255,255,0,.16);background:rgba(0,0,0,.22);
}
.checkItem input[type="checkbox"]{width:auto;margin-top:3px}
.checkItem .txt{display:flex;flex-direction:column;gap:3px}
.checkItem .txt b{font-size:13px}
.checkItem .txt small{color:var(--mut);font-size:12px;line-height:1.25}

.penQty{display:flex;gap:8px;align-items:center;margin-left:auto}
.penBadge{padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,0,.22);background:rgba(0,0,0,.25);font-size:12px;color:var(--yn);min-width:54px;text-align:center}
.tiny{padding:7px 10px;border-radius:12px;font-size:12px}

.modal{position:fixed;inset:0;background:rgba(0,0,0,.72);display:none;align-items:center;justify-content:center;padding:12px;z-index:9999}
.modal .box{width:min(980px,100%);max-height:92vh;overflow:auto;background:rgba(10,10,15,.98);border:1px solid rgba(255,255,0,.22);border-radius:18px;box-shadow:var(--sh);padding:14px}
.modal .head{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
.modal .head .pill{color:var(--yn)}

.sumula{background:#fff;color:#111;border-radius:12px;padding:0;margin-top:12px}
.page{padding:18px 18px 14px 18px;border-bottom:1px dashed #bbb}
.page:last-child{border-bottom:none}
.s-title{font-weight:900;text-align:center;letter-spacing:.4px}
.s-sub{text-align:center;font-size:12px;color:#333;margin-top:4px}
.s-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
.s-line{border:1px solid #333;padding:8px;font-size:12px}
.s-line b{display:block;font-size:11px;color:#333;margin-bottom:3px}
.s-table{width:100%;border-collapse:collapse;font-size:11px;margin-top:10px}
.s-table td,.s-table th{border:1px solid #333;padding:6px;vertical-align:top}
.s-table th{background:#f2f2f2}
.sig{display:flex;gap:14px;align-items:flex-end;justify-content:space-between;margin-top:16px}
.sig img{max-width:320px;height:auto;border:1px solid #333;padding:6px}
.sig .block{flex:1;font-size:11px}
.sig .line{border-top:1px solid #333;margin-top:30px;padding-top:4px}

@media print {
  body{background:#fff;color:#111}
  .wrap,.top,.grid,.card,.modal{display:none!important}
  #printArea{display:block!important}
  #printArea .page{page-break-after:always}
  #printArea .page:last-child{page-break-after:auto}
}
</style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div>
      <h1>RITE ‚Ä¢ S√∫mulas de Tiro</h1>
      <div class="sub">Aluno: cabe√ßalho ‚Ä¢ Instrutor: tiros 1 a 1 + procedimentos + penalidades (quantidade) + reprova√ß√£o ‚Ä¢ Nota (3 casas) ‚Ä¢ Consulta por RE</div>
    </div>
    <div id="badge" class="badge">OFFLINE</div>
  </div>

  <div class="grid">
    <!-- ESQUERDA -->
    <div class="card">
      <div class="pill">üîê Login</div>
      <div class="sep"></div>
      <div class="row">
        <div class="field">
          <label>Usu√°rio (RE do aluno OU Fenille)</label>
          <input id="loginUser" placeholder="Ex.: 123456-7 ou Fenille">
        </div>
        <div class="field">
          <label>Senha</label>
          <input id="loginPass" type="password" placeholder="Senha">
        </div>
      </div>
      <div class="btns">
        <button class="primary" id="btnLogin">Entrar</button>
        <button id="btnDemoAluno">Demo Aluno</button>
        <button id="btnDemoInstr">Demo Instrutor</button>
      </div>

      <div class="sep"></div>

      <div class="pill">üîé Consulta por RE</div>
      <div class="muted" style="margin-top:8px">Mostra todas as avalia√ß√µes do RE e permite visualizar a s√∫mula.</div>
      <div class="row" style="margin-top:10px">
        <div class="field" style="grid-column:span 8">
          <label>RE</label>
          <input id="consultaRE" placeholder="Ex.: 123456-7">
        </div>
        <div class="field" style="grid-column:span 4;align-self:end">
          <button class="primary" id="btnConsultar">Consultar</button>
        </div>
      </div>
      <div class="sep"></div>
      <div class="list" id="consultaList"></div>

      <div class="sep"></div>
      <div class="muted">
        Aluno: senha padr√£o <b>1234</b><br>
        Instrutor: <b>Fenille</b> / <b>140965</b>
      </div>
    </div>

    <!-- DIREITA -->
    <div class="card" id="appCard" style="display:none;">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;">
        <div>
          <div class="pill" id="whoPill">üë§</div>
          <div class="muted" id="whoSub"></div>
        </div>
        <div class="tabs">
          <button id="tabAluno" style="display:none;">Tela do Aluno</button>
          <button id="tabInstr" style="display:none;">Painel do Instrutor</button>
          <button class="danger" id="btnLogout">Sair</button>
        </div>
      </div>

      <div class="sep"></div>

      <!-- VIEW: ALUNO -->
      <div id="viewAluno" style="display:none;">
        <div class="pill">üìù Cabe√ßalho (Aluno)</div>
        <div class="muted" style="margin-top:8px">
          Digite o <b>RE</b> e o sistema tenta puxar os dados do cadastro. Se existir, bloqueia edi√ß√£o (evita trocar o nome no RE).
        </div>
        <div class="sep"></div>

        <div class="row">
          <div class="field" style="grid-column:span 6">
            <label>Tipo</label>
            <select id="tipo">
              <option value="PPA_PISTOLA">PPA ‚Ä¢ Pistola .40</option>
              <option value="PPA_ESP12">PPA ‚Ä¢ Espingarda 12</option>
            </select>
          </div>
          <div class="field" style="grid-column:span 6">
            <label>Data</label>
            <input id="data" type="date">
          </div>

          <div class="field" style="grid-column:span 6">
            <label>Local</label>
            <input id="local" placeholder="Estande / Localidade">
          </div>
          <div class="field" style="grid-column:span 6">
            <label>Unidade</label>
            <input id="unidade" placeholder="18¬∫ BPM/I">
          </div>

          <div class="field" style="grid-column:span 6">
            <label>Nome</label>
            <input id="aNome" placeholder="Nome completo">
          </div>
          <div class="field" style="grid-column:span 3">
            <label>RE</label>
            <input id="aRE" placeholder="RE">
          </div>
          <div class="field" style="grid-column:span 3">
            <label>Posto/Grad</label>
            <input id="aPG" placeholder="Sd PM">
          </div>

          <div class="field" style="grid-column:span 6">
            <label>N¬∫ da arma</label>
            <input id="aArma" placeholder="12345">
          </div>

          <div class="field">
            <label>Observa√ß√µes (opcional)</label>
            <textarea id="obsAluno" placeholder="..."></textarea>
          </div>
        </div>

        <div class="btns">
          <button class="primary" id="btnEnviar">Enviar para o instrutor</button>
        </div>

        <div class="sep"></div>
        <div class="muted" id="alunoMsg"></div>
      </div>

      <!-- VIEW: INSTRUTOR -->
      <div id="viewInstr" style="display:none;">
        <div class="pill">üßë‚Äçüè´ Painel do Instrutor</div>
        <div class="muted" style="margin-top:8px">Carrega as √∫ltimas 50 avalia√ß√µes.</div>

        <div class="sep"></div>
        <div class="kpi">
          <span class="pill" id="kpiTotal">Total: 0</span>
          <span class="pill" id="kpiAguard">Aguardando: 0</span>
          <span class="pill" id="kpiFinal">Finalizados: 0</span>
        </div>

        <div class="sep"></div>
        <div class="list" id="instrList"></div>

        <div class="sep"></div>

        <div id="editor" style="display:none;">
          <div class="pill">‚úçÔ∏è Corre√ß√£o</div>
          <div class="muted" id="edHeader" style="margin-top:8px"></div>

          <div class="sep"></div>

          <!-- M√ìDULO 1 -->
          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;">
            <div class="pill">‚ë† Tiros (1 por 1)</div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="tiny" id="btnZerarTiros">Zerar</button>
              <button class="tiny" id="btnMaxTiros">M√°ximo</button>
            </div>
          </div>
          <div class="muted" id="shotsHelp" style="margin:8px 0 10px 0"></div>
          <div class="shotsGrid" id="shotsGrid"></div>

          <div class="sep"></div>

          <!-- M√ìDULO 2 -->
          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;">
            <div class="pill">‚ë° Procedimentos (25)</div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="tiny" id="btnAllProcOK">Todos corretos</button>
              <button class="tiny" id="btnAllProcErr">Todos errados</button>
            </div>
          </div>
          <div class="muted" style="margin:8px 0 10px 0">Padr√£o: todos corretos. Desmarque o que estiver errado.</div>
          <div class="checks" id="procList"></div>

          <div class="sep"></div>

          <!-- M√ìDULO 3 -->
          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;">
            <div class="pill">‚ë¢ Penalidades (quantidade)</div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="tiny" id="btnClearPen">Limpar</button>
            </div>
          </div>
          <div class="muted" style="margin:8px 0 10px 0">
            Clique em <b>Marcar</b> e informe <b>?x</b>. Ex.: ‚ÄúDisparo a mais‚Äù 3 vezes ‚Üí ?x = 3.
          </div>
          <div class="checks" id="penList"></div>

          <div class="sep"></div>

          <div class="pill">‚ë£ Reprova√ß√£o (penalidades fatais)</div>
          <div class="muted" style="margin:8px 0 10px 0">Marque as que ocorreram (se marcar qualquer uma, status sugere ‚ÄúREPROVADO‚Äù).</div>
          <div class="checks" id="repList"></div>

          <div class="sep"></div>

          <!-- RESUMO -->
          <div class="pill">üìå Resultado autom√°tico</div>
          <div class="row" style="margin-top:10px">
            <div class="field" style="grid-column:span 3">
              <label>A (Tiros)</label>
              <input id="pA" disabled />
            </div>
            <div class="field" style="grid-column:span 3">
              <label>B (Proced.)</label>
              <input id="pB" disabled />
            </div>
            <div class="field" style="grid-column:span 3">
              <label>C (Penal.)</label>
              <input id="pC" disabled />
            </div>
            <div class="field" style="grid-column:span 3">
              <label>E = A + B ‚àí C</label>
              <input id="pE" disabled />
            </div>
            <div class="field" style="grid-column:span 4">
              <label>Nota (0‚Äì350, 3 casas)</label>
              <input id="nota" disabled />
            </div>
            <div class="field" style="grid-column:span 4">
              <label>Conceito</label>
              <input id="conceito" disabled />
            </div>
            <div class="field" style="grid-column:span 4">
              <label>Status</label>
              <input id="statusShow" disabled />
            </div>

            <div class="field">
              <label>Observa√ß√µes do instrutor</label>
              <textarea id="obsInstr" placeholder="..."></textarea>
            </div>
          </div>

          <div class="btns">
            <button class="primary" id="btnSalvar">Salvar</button>
            <button id="btnValidar">VALIDAR</button>
            <button id="btnVerSumula">Ver S√∫mula</button>
            <button id="btnFecharEditor">Fechar</button>
          </div>
          <div class="muted" style="margin-top:8px">
            No celular: <b>Ver S√∫mula</b> (visualiza√ß√£o). No desktop: dentro da s√∫mula aparece o bot√£o <b>Imprimir / Salvar PDF</b>.
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL -->
<div id="modal" class="modal">
  <div class="box">
    <div class="head">
      <div>
        <div class="pill" id="modalTitle">üìÑ S√∫mula</div>
        <div class="muted" id="modalSub"></div>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
        <button id="btnPrint" class="primary">Imprimir / Salvar PDF</button>
        <button id="btnCloseModal" class="danger">Fechar</button>
      </div>
    </div>
    <div id="modalBody"></div>
  </div>
</div>

<!-- PRINT AREA (injetado) -->
<div id="printArea" style="display:none"></div>

<script>
/*************** FIREBASE RTDB (REST) ***************/
const DATABASE_URL = "https://rite-fa75b-default-rtdb.firebaseio.com";

/*************** LOGINS ***************/
const INSTRUTOR_USER = "Fenille";
const INSTRUTOR_PASS = "140965";
const ALUNO_PASS = "1234";

/*************** TEXTOS (extra√≠dos das s√∫mulas originais) ***************/
const TEXTOS = {
  PPA_PISTOLA: {
    proc: ["Mediante ordem preparar a pistola para executar a ‚ÄúPPA‚Äù colocando-a no coldre (alimentada, carregada, c√£o desarmado, travada, coldre abotoado). Primeiro carregador com 6 (seis) cartuchos; um carregador de reposi√ß√£o com 10 (dez) cartuchos.", "Ao sinal convencionado sacar a pistola e colocar-se em prote√ß√£o no abrigo ‚ÄùA‚Äù, com rapidez, em condi√ß√µes de atuar e disparar", "Varredura e sa√≠da do abrigo ‚ÄúA‚Äù", "Primeira progress√£o (do abrigo ‚ÄúA‚Äù at√© o abrigo ‚ÄúB‚Äù)", "Proteger-se e atuar corretamente no abrigo ‚ÄúB‚Äù e progress√£o at√© o abrigo ‚ÄúC‚Äù", "Proteger-se e atuar corretamente no abrigo ‚ÄúC‚Äù e progress√£o at√© o abrigo ‚ÄúD‚Äù", "Proteger-se e atuar corretamente na ‚Äújanela baixa‚Äù (abrigo ‚ÄúD‚Äù)", "Proteger-se e atuar corretamente no canto da direita (abrigo ‚ÄúD)", "Primeira verbaliza√ß√£o obrigat√≥ria, com posi√ß√£o correta da arma (abrigo ‚ÄúD‚Äù)", "Proteger-se e atuar corretamente na ‚Äújanela alta‚Äù (abrigo ‚ÄúD‚Äù)", "Proteger-se e atuar corretamente no canto da esquerda (abrigo ‚ÄúD‚Äù)", "Segunda verbaliza√ß√£o obrigat√≥ria, com posi√ß√£o correta da arma (abrigo ‚ÄúD‚Äù)", "Terceira verbaliza√ß√£o obrigat√≥ria, com posi√ß√£o correta da arma (abrigo ‚ÄúD‚Äù)", "Recarregar a pistola corretamente, com rapidez, protegido, e sem perder o contato visual com a √°rea de perigo (recarga t√°tica ou emergencial, a crit√©rio do aluno).", "Atuar com a pistola sempre carregada", "Efetuar os disparos com rapidez (dois de cada vez em cada alvo atir√°vel).", "Conduzir a pistola corretamente, com o cano e o olhar na dire√ß√£o do perigo.", "Dedo fora do gatilho quando dos deslocamentos, e quando n√£o for para atirar", "Outras verbaliza√ß√µes, com posi√ß√£o correta da arma.", "Aplica√ß√£o de sinais policiais, em situa√ß√µes obrigat√≥rias, como se estivesse com um companheiro", "Proteger-se corretamente nos demais procedimentos.", "Regress√£o (do abrigo ‚ÄúD‚Äù at√© o abrigo ‚ÄúA‚Äù)", "Terminada a regress√£o coldrear a pistola, em seguran√ßa, sem descarreg√°-la, travada. Aguardar ordens", "Mediante ordem retirar a pistola do coldre, descarreg√°-la, com seguran√ßa, entregando-a ao professor como se a estivesse entregando na reserva de armas ou a outro companheiro", "Solu√ß√£o de incidentes de tiro (caso ocorram)"],
    pen:  ["Arma e equipamentos mal ajustados ao corpo atrapalhando a execu√ß√£o dos exerc√≠cios.", "Disparo, sem acerto, em alvo n√£o atir√°vel. Cada disparo uma penalidade. Ver item seguinte", "Acerto em alvo n√£o atir√°vel. Cada acerto duas penalidades. Ver item anterior (um n√£o exclui o outro)", "Disparos no mesmo alvo, al√©m do determinado (cada disparo a mais uma penalidade)", "Deixar de disparar contra alvo agressor obrigatoriamente atir√°vel (cada disparo uma penalidade).", "N√£o manter a arma em ‚Äúposi√ß√£o de tiro‚Äù, efetuando ‚Äúvarredura‚Äù, ap√≥s os disparos", "Derrubar o carregador de reposi√ß√£o", "Acionar o gatilho estando a pistola travada ou descarregada.", "Ultrapassar a arma, ou qualquer parte do corpo, para al√©m da zona de seguran√ßa.", "N√£o completar a pista por falta de muni√ß√£o (uma penalidade para cada tiro faltante).", "Precipitar-se. Praticar a valentia perigosa. N√£o pedir apoio quando necess√°rio."],
    rep:  ["Apresentar descontrole emocional", "Atentar contra as normas de seguran√ßa", "Demonstrar dificuldades no manejo ou na atua√ß√£o com a pistola.", "Disparar para fora do barranco de conten√ß√£o dos proj√©teis.", "Disparo acidental com ou sem v√≠tima.", "Derrubar a pistola."],
  },
  PPA_ESP12: {
    proc: ["Mediante ordem preparar a espingarda para executar a ‚ÄúPPA‚Äù (alimentada; dep√≥sito com 3 cartuchos, mais 5 de reposi√ß√£o no porta cartuchos, todos ‚Äúsingular‚Äù ‚Äì proj√©til √∫nico; em bandoleira de tr√™s pontos individualizada; ‚Äúposi√ß√£o sul‚Äù)", "Ao sinal convencionado carregar a espingarda e colocar-se em prote√ß√£o no abrigo ‚ÄùA‚Äù, com rapidez, em condi√ß√µes de atuar e disparar", "Varredura e sa√≠da do primeiro abrigo (abrigo ‚ÄúA‚Äù)", "Primeira progress√£o (do abrigo ‚ÄúA‚Äù at√© o abrigo ‚ÄúB‚Äù)", "Proteger-se e atuar corretamente no abrigo ‚ÄúB‚Äù e progress√£o at√© o abrigo ‚ÄúC‚Äù", "Proteger-se e atuar corretamente no abrigo ‚ÄúC‚Äù e progress√£o at√© o abrigo ‚ÄúD‚Äù", "Proteger-se e atuar corretamente na ‚Äújanela baixa‚Äù (abrigo ‚ÄúD‚Äù)", "Proteger-se e atuar corretamente no canto da direita (abrigo ‚ÄúD‚Äù)", "Primeira verbaliza√ß√£o obrigat√≥ria, com posi√ß√£o correta da arma (abrigo ‚ÄúD‚Äù)", "Proteger-se e atuar corretamente na ‚Äújanela alta‚Äù (abrigo ‚ÄúD‚Äù)", "Proteger-se e atuar corretamente no canto da esquerda (abrigo ‚ÄúD‚Äù)", "Segunda verbaliza√ß√£o obrigat√≥ria, com posi√ß√£o correta da arma (abrigo ‚ÄúD‚Äù)", "Terceira verbaliza√ß√£o obrigat√≥ria, com posi√ß√£o correta da arma (abrigo ‚ÄúD‚Äù)", "Realimentar e recarregar a espingarda corretamente, com rapidez, protegido, e sem perder o contato visual com a √°rea de perigo (t√°tica ou emergencial, a crit√©rio do aluno).", "Atuar com a espingarda sempre carregada", "Efetuar o disparo com rapidez (um disparo em cada alvo atir√°vel)", "Conduzir a espingarda corretamente, com o cano e o olhar na dire√ß√£o do perigo.", "Dedo fora do gatilho quando dos deslocamentos, e quando n√£o for para atirar", "Outras verbaliza√ß√µes, com posi√ß√£o correta da arma.", "Aplica√ß√£o de sinais policiais, em situa√ß√µes obrigat√≥rias, como se estivesse com um companheiro", "Proteger-se corretamente nos demais procedimentos.", "Regress√£o (do abrigo ‚ÄúD‚Äù at√© o abrigo ‚ÄúA‚Äù).", "Terminada a regress√£o colocar a espingarda em ‚Äúposi√ß√£o sul‚Äù, gatilho travado, sem descarreg√°-la. Aguardar ordens", "Mediante ordem, descarregar a espingarda, com seguran√ßa, entregando-a ao professor, como se a estivesse entregando na reserva de armas, ou a outro companheiro", "Solu√ß√£o de incidentes de tiro (caso ocorram)"],
    pen:  ["Arma e equipamentos mal ajustados ao corpo atrapalhando a execu√ß√£o dos exerc√≠cios.", "Disparo, sem acerto, em alvo n√£o atir√°vel. Cada disparo uma penalidade. Ver item seguinte", "Acerto em alvo n√£o atir√°vel. Cada acerto duas penalidades. Ver item anterior (um n√£o exclui o outro)", "Disparos no mesmo alvo, al√©m do determinado (cada disparo a mais uma penalidade)", "Deixar de disparar contra alvo agressor obrigatoriamente atir√°vel (cada disparo uma penalidade).", "Recarregar e manter a arma em ‚Äúposi√ß√£o de tiro‚Äù, efetuando ‚Äúvarredura‚Äù, ap√≥s os disparos", "Derrubar muni√ß√£o de reposi√ß√£o", "Acionar o gatilho estando a espingarda descarregada ou com o gatilho travado.", "Ultrapassar a arma, ou qualquer parte do corpo, para al√©m da zona de seguran√ßa.", "N√£o completar a pista por falta de muni√ß√£o (uma penalidade para cada tiro faltante).", "Precipitar-se. Praticar a valentia perigosa. N√£o pedir apoio quando necess√°rio."],
    rep:  ["Apresentar descontrole emocional", "Atentar contra as normas de seguran√ßa", "Demonstrar dificuldades no manejo ou na atua√ß√£o com a espingarda.", "Disparar para fora do barranco de conten√ß√£o dos proj√©teis.", "Disparo acidental com ou sem v√≠tima.", "Derrubar a espingarda."],
  },
};

/*************** REGRAS ***************/
const RULES = {
  PPA_PISTOLA: { max: 350, shots: 44, shotOptions: [0,5,10], procCount: 25, procPts: 10, penPts: 10 },
  PPA_ESP12:   { max: 350, shots: 22, shotOptions: [0,10,20], procCount: 25, procPts: 10, penPts: 10 },
};

let session=null; // {role, re/user}
let currentId=null;
let currentObj=null;

const $ = (id)=>document.getElementById(id);
const safe=(s)=>(s??"").toString().trim();
const isoNow=()=> new Date().toISOString();
const isDesktop=()=> window.matchMedia("(min-width: 920px)").matches;

function setBadge(text, ok){
  const b=$("badge");
  b.textContent=text;
  b.classList.toggle("ok", !!ok);
}

/*************** REST HELPERS ***************/
async function rtdbGet(path, query=""){
  const url = `${DATABASE_URL}/${path}.json${query}`;
  const res = await fetch(url);
  if(!res.ok) throw new Error(await res.text());
  return await res.json();
}
async function rtdbPut(path, data){
  const url = `${DATABASE_URL}/${path}.json`;
  const res = await fetch(url, {method:"PUT", headers:{"Content-Type":"application/json"}, body:JSON.stringify(data)});
  if(!res.ok) throw new Error(await res.text());
  return await res.json();
}
async function rtdbPatch(path, data){
  const url = `${DATABASE_URL}/${path}.json`;
  const res = await fetch(url, {method:"PATCH", headers:{"Content-Type":"application/json"}, body:JSON.stringify(data)});
  if(!res.ok) throw new Error(await res.text());
  return await res.json();
}
async function rtdbPost(path, data){
  const url = `${DATABASE_URL}/${path}.json`;
  const res = await fetch(url, {method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(data)});
  if(!res.ok) throw new Error(await res.text());
  return await res.json();
}
async function rtdbDelete(path){
  const url = `${DATABASE_URL}/${path}.json`;
  const res = await fetch(url, {method:"DELETE"});
  if(!res.ok) throw new Error(await res.text());
  return true;
}

/*************** CONCEITO ***************/
function conceitoPorNota(n){
  // nota = pontos finais (0..350)
  const pct = (n/350)*100;
  if (pct <= 49) return "Insuficiente";
  if (pct <= 69) return "Regular";
  if (pct <= 84) return "Bom";
  if (pct <= 95) return "Muito bom";
  return "Excepcional";
}

function show(el, yes){ el.style.display = yes ? "" : "none"; }

function openAluno(){ show($("viewAluno"), true); show($("viewInstr"), false); }
function openInstr(){ show($("viewAluno"), false); show($("viewInstr"), true); loadInstrList(); }

function setRoleUI(){
  show($("appCard"), true);
  if(session.role==="aluno"){
    $("whoPill").textContent="üßë‚ÄçüéØ Aluno";
    $("whoSub").textContent=`RE: ${session.re}`;
    show($("tabAluno"), true);
    show($("tabInstr"), false);
    $("aRE").value=session.re;
    openAluno();
  } else {
    $("whoPill").textContent="üßë‚Äçüè´ Instrutor";
    $("whoSub").textContent=`Usu√°rio: ${session.user}`;
    show($("tabAluno"), false);
    show($("tabInstr"), true);
    openInstr();
  }
}

function logout(){
  session=null; currentId=null; currentObj=null;
  show($("appCard"), false);
  $("loginUser").value=""; $("loginPass").value="";
}

function login(){
  const u=safe($("loginUser").value);
  const p=safe($("loginPass").value);
  if(!u||!p) return alert("Preencha usu√°rio e senha.");
  if(u.toLowerCase()===INSTRUTOR_USER.toLowerCase() && p===INSTRUTOR_PASS){
    session={role:"instrutor", user:INSTRUTOR_USER};
    setRoleUI(); return;
  }
  if(p!==ALUNO_PASS) return alert("Senha inv√°lida.");
  session={role:"aluno", re:u};
  setRoleUI();
}

/*************** CADASTRO POR RE (auto-fill / lock) ***************/
async function carregarCadastroRE(){
  const re = safe($("aRE").value) || (session?.role==="aluno" ? session.re : "");
  if(!re) return;
  try{
    const cad = await rtdbGet(`cadastrosAlunos/${encodeURIComponent(re)}`);
    if(cad && cad.nome){
      $("aNome").value = cad.nome || "";
      $("aPG").value = cad.postoGrad || "";
      $("unidade").value = cad.unidade || "";
      // trava
      $("aNome").disabled = true;
      $("aPG").disabled = true;
      $("unidade").disabled = true;
      $("alunoMsg").textContent = "‚úÖ Cadastro encontrado. Campos bloqueados para evitar trocar o nome no RE.";
    } else {
      $("aNome").disabled = false;
      $("aPG").disabled = false;
      $("unidade").disabled = false;
      $("alunoMsg").textContent = "‚ÑπÔ∏è RE sem cadastro ainda. Preencha os dados (ser√£o gravados para este RE).";
    }
  }catch(e){
    // se rules bloquearem leitura, mant√©m edit√°vel
    $("aNome").disabled = false;
    $("aPG").disabled = false;
    $("unidade").disabled = false;
  }
}

/*************** ALUNO: ENVIAR CABE√áALHO ***************/
async function enviarCabecalho(){
  const tipo = $("tipo").value;
  const rule = RULES[tipo];
  if(!rule) return alert("Tipo inv√°lido.");

  const re = safe($("aRE").value) || session.re;
  const payload={
    tipo,
    data: $("data").value || "",
    local: safe($("local").value),
    unidade: safe($("unidade").value),
    aluno1:{
      nome: safe($("aNome").value),
      re,
      postoGrad: safe($("aPG").value),
      armaNumero: safe($("aArma").value),
    },
    obsAluno: safe($("obsAluno").value),
    status:"AGUARDANDO_INSTRUTOR",
    criadoEm: isoNow(),
    criadoPor: session.re,
    correcao:{
      tiros: Array(rule.shots).fill(0),
      procedimentosOK: Array(rule.procCount).fill(true),
      penalidadesQtd: {}, // {idx:qty}
      reprovacao: Array(TEXTOS[tipo].rep.length).fill(false),
      A:0,B:rule.procCount*rule.procPts,C:0,E:0,nota:0,conceito:"",
      obsInstr:""
    },
    validadoEm:null, validadoPor:null
  };

  if(!payload.data || !payload.local || !payload.unidade || !payload.aluno1.nome || !payload.aluno1.re){
    return alert("Preencha: Data, Local, Unidade, Nome e RE.");
  }

  try{
    // salva cadastro do RE se n√£o existir
    await rtdbPatch(`cadastrosAlunos/${encodeURIComponent(re)}`, {
      nome: payload.aluno1.nome,
      postoGrad: payload.aluno1.postoGrad,
      unidade: payload.unidade,
      atualizadoEm: isoNow()
    });

    const resp = await rtdbPost("avaliacoes", payload);
    const id = resp?.name;
    if(!id) throw new Error("Push n√£o retornou ID.");

    await rtdbPut(`indexPorRE/${encodeURIComponent(re)}/${id}`, true);

    $("alunoMsg").textContent = `‚úÖ Enviado! ID: ${id}`;
    // limpa (mant√©m RE)
    $("aArma").value=""; $("obsAluno").value="";
  }catch(e){
    console.error(e);
    alert("Erro ao enviar. Verifique Rules/Conex√£o do Firebase.");
  }
}

/*************** CONSULTA POR RE ***************/
async function consultarRE(){
  const re=safe($("consultaRE").value);
  if(!re) return alert("Digite um RE.");
  $("consultaList").innerHTML = `<div class="muted">Consultando‚Ä¶</div>`;
  try{
    const idx = await rtdbGet(`indexPorRE/${encodeURIComponent(re)}`);
    if(!idx){ $("consultaList").innerHTML=`<div class="muted">Nenhum registro para esse RE.</div>`; return; }
    const ids = Object.keys(idx);
    const reads = await Promise.all(ids.map(id => rtdbGet(`avaliacoes/${id}`)));
    const items = reads.map((v,i)=> ({id:ids[i], ...v}))
      .filter(x=>x && x.tipo)
      .sort((a,b)=> (b.criadoEm||"").localeCompare(a.criadoEm||""));

    $("consultaList").innerHTML="";
    for(const it of items){
      const nome = it.aluno1?.nome || "(sem nome)";
      const tipo = it.tipo || "-";
      const data = it.data || "-";
      const st = it.status || "-";
      const E = it.correcao?.E ?? 0;
      const conc = it.correcao?.conceito ?? "-";

      const div=document.createElement("div");
      div.className="item";
      div.innerHTML = `
        <div>
          <div><b>${nome}</b> ‚Ä¢ ${tipo}</div>
          <div class="muted">${data} ‚Ä¢ <span style="color:${st==='FINALIZADO'?'#a8ffb0':'#fff0a8'}">${st}</span></div>
        </div>
        <div class="right">
          <span class="pill">E: ${E}</span>
          <span class="pill">${conc}</span>
          <button class="tiny" data-id="${it.id}">Ver</button>
        </div>
      `;
      div.querySelector("button").addEventListener("click", ()=> openSumulaModal(it.id, it, "consulta"));
      $("consultaList").appendChild(div);
    }
  }catch(e){
    console.error(e);
    $("consultaList").innerHTML = `<div class="muted">Erro: permiss√µes (Rules) ou conex√£o.</div>`;
  }
}

/*************** INSTRUTOR LISTA ***************/
async function loadInstrList(){
  $("instrList").innerHTML = `<div class="muted">Carregando‚Ä¶</div>`;
  try{
    const data = await rtdbGet("avaliacoes", `?orderBy="$key"&limitToLast=50`);
    const ids = data ? Object.keys(data) : [];
    const items = ids.map(id => ({id, ...data[id]}))
      .filter(x=>x && x.tipo)
      .sort((a,b)=> (b.criadoEm||"").localeCompare(a.criadoEm||""));

    let total=items.length, aguard=0, fin=0;
    for(const it of items){ if(it.status==="AGUARDANDO_INSTRUTOR") aguard++; if(it.status==="FINALIZADO") fin++; }
    $("kpiTotal").textContent=`Total: ${total}`;
    $("kpiAguard").textContent=`Aguardando: ${aguard}`;
    $("kpiFinal").textContent=`Finalizados: ${fin}`;

    $("instrList").innerHTML="";
    for(const it of items){
      const nome=it.aluno1?.nome||"(sem nome)";
      const re=it.aluno1?.re||"-";
      const tipo=it.tipo||"-";
      const dataS=it.data||"-";
      const st=it.status||"-";
      const E=it.correcao?.E ?? 0;

      const div=document.createElement("div");
      div.className="item";
      div.innerHTML=`
        <div>
          <div><b>${nome}</b> ‚Ä¢ RE ${re}</div>
          <div class="muted">${tipo} ‚Ä¢ ${dataS} ‚Ä¢ <span style="color:${st==='FINALIZADO'?'#a8ffb0':'#fff0a8'}">${st}</span></div>
        </div>
        <div class="right">
          <span class="pill">E: ${E}</span>
          <button class="tiny">Abrir</button>
        </div>
      `;
      div.querySelector("button").addEventListener("click", ()=> openEditor(it.id, it));
      $("instrList").appendChild(div);
    }
  }catch(e){
    console.error(e);
    $("instrList").innerHTML = `<div class="muted">Erro: permiss√µes (Rules) ou conex√£o.</div>`;
  }
}

/*************** EDITOR ***************/
function openEditor(id, it){
  currentId=id;
  currentObj=it;

  const rule = RULES[currentObj.tipo];
  if(!rule) return alert("Tipo n√£o suportado: "+currentObj.tipo);

  if(!currentObj.correcao) currentObj.correcao={};
  if(!Array.isArray(currentObj.correcao.tiros) || currentObj.correcao.tiros.length!==rule.shots){
    currentObj.correcao.tiros = Array(rule.shots).fill(0);
  }
  if(!Array.isArray(currentObj.correcao.procedimentosOK) || currentObj.correcao.procedimentosOK.length!==rule.procCount){
    currentObj.correcao.procedimentosOK = Array(rule.procCount).fill(true);
  }
  if(!currentObj.correcao.penalidadesQtd || typeof currentObj.correcao.penalidadesQtd!=="object") {
    currentObj.correcao.penalidadesQtd = {};
  }
  if(!Array.isArray(currentObj.correcao.reprovacao)) {
    currentObj.correcao.reprovacao = Array(TEXTOS[currentObj.tipo].rep.length).fill(false);
  }

  $("edHeader").textContent = `ID ${id} ‚Ä¢ ${currentObj.tipo} ‚Ä¢ ${currentObj.data||"-"} ‚Ä¢ ${currentObj.aluno1?.nome||"-"} (RE ${currentObj.aluno1?.re||"-"})`;

  $("shotsHelp").textContent = currentObj.tipo==="PPA_PISTOLA"
    ? `Pistola: ${rule.shots} tiros ‚Ä¢ valores: ${rule.shotOptions.join(", ")}`
    : `Espingarda 12: ${rule.shots} tiros ‚Ä¢ valores: ${rule.shotOptions.join(", ")}`;

  buildShots(rule);
  buildProcedures(rule);
  buildPenalties(rule);
  buildReprovacao();

  $("obsInstr").value = currentObj.correcao.obsInstr || "";
  $("statusShow").value = currentObj.status || "-";

  recomputeAll();
  show($("editor"), true);
  window.scrollTo({top:0,behavior:"smooth"});
}

function closeEditor(){ currentId=null; currentObj=null; show($("editor"), false); }

function buildShots(rule){
  const grid=$("shotsGrid");
  grid.innerHTML="";
  for(let i=0;i<rule.shots;i++){ 
    const cell=document.createElement("div");
    cell.className="shotCell";
    cell.innerHTML = `<label>Tiro ${i+1}</label>`;
    const sel=document.createElement("select");
    for(const v of rule.shotOptions){
      const op=document.createElement("option");
      op.value=String(v); op.textContent=String(v);
      sel.appendChild(op);
    }
    sel.value=String(currentObj.correcao.tiros[i] ?? 0);
    sel.addEventListener("change", ()=>{ currentObj.correcao.tiros[i]=Number(sel.value); recomputeAll(); });
    cell.appendChild(sel);
    grid.appendChild(cell);
  }
}

function buildProcedures(rule){
  const box=$("procList"); box.innerHTML="";
  const arr = TEXTOS[currentObj.tipo].proc;
  for(let i=0;i<rule.procCount;i++){ 
    const wrap=document.createElement("div");
    wrap.className="checkItem";
    const cb=document.createElement("input");
    cb.type="checkbox";
    cb.checked = (currentObj.correcao.procedimentosOK[i] ?? true);
    cb.addEventListener("change", ()=>{ currentObj.correcao.procedimentosOK[i]=cb.checked; recomputeAll(); });
    const txt=document.createElement("div");
    txt.className="txt";
    txt.innerHTML = `<b>Procedimento ${String(i+1).padStart(2,"0")}</b><small>${arr[i]||""}</small>`;
    wrap.appendChild(cb); wrap.appendChild(txt);
    box.appendChild(wrap);
  }
}

function buildPenalties(rule){
  const box=$("penList"); box.innerHTML="";
  const arr = TEXTOS[currentObj.tipo].pen;
  const qtd = currentObj.correcao.penalidadesQtd || {};
  for(let i=0;i<arr.length;i++){ 
    const wrap=document.createElement("div");
    wrap.className="checkItem";
    const txt=document.createElement("div");
    txt.className="txt";
    txt.innerHTML = `<b>Penalidade ${String(i+1).padStart(2,"0")}</b><small>${arr[i]||""} <br><i>10 pontos negativos por ocorr√™ncia.</i></small>`;
    const right=document.createElement("div");
    right.className="penQty";
    const badge=document.createElement("div");
    const cur = Number(qtd[i]||0);
    badge.className="penBadge";
    badge.textContent = cur>0 ? `x${cur}` : "‚Äî";
    const btn=document.createElement("button");
    btn.className="tiny";
    btn.textContent = "Marcar";
    btn.addEventListener("click", ()=>{
      const curv = Number(currentObj.correcao.penalidadesQtd[i]||0);
      const ans = prompt(`Penalidade ${String(i+1).padStart(2,"0")}\nQuantas vezes (?x)?`, String(curv||0));
      if(ans===null) return;
      let n = parseInt(ans,10);
      if(Number.isNaN(n) || n<0) n=0;
      if(n===0) delete currentObj.correcao.penalidadesQtd[i];
      else currentObj.correcao.penalidadesQtd[i]=n;
      buildPenalties(rule);
      recomputeAll();
    });
    right.appendChild(badge);
    right.appendChild(btn);
    wrap.appendChild(txt);
    wrap.appendChild(right);
    box.appendChild(wrap);
  }
}

function buildReprovacao(){
  const box=$("repList"); box.innerHTML="";
  const arr = TEXTOS[currentObj.tipo].rep;
  for(let i=0;i<arr.length;i++){ 
    const wrap=document.createElement("div");
    wrap.className="checkItem";
    const cb=document.createElement("input");
    cb.type="checkbox";
    cb.checked = !!currentObj.correcao.reprovacao[i];
    cb.addEventListener("change", ()=>{ currentObj.correcao.reprovacao[i]=cb.checked; recomputeAll(); });
    const txt=document.createElement("div");
    txt.className="txt";
    txt.innerHTML = `<b>Reprova√ß√£o ${String(i+1).padStart(2,"0")}</b><small>${arr[i]||""}</small>`;
    wrap.appendChild(cb); wrap.appendChild(txt);
    box.appendChild(wrap);
    box.appendChild(wrap);
  }
}

function recomputeAll(){
  const rule = RULES[currentObj.tipo];
  const A = (currentObj.correcao.tiros||[]).reduce((s,v)=> s+Number(v||0), 0);
  const okCount = (currentObj.correcao.procedimentosOK||[]).filter(Boolean).length;
  const B = okCount * rule.procPts;

  const qtd = currentObj.correcao.penalidadesQtd || {};
  let penCount = 0;
  for(const k in qtd) penCount += Number(qtd[k]||0);
  const C = penCount * rule.penPts;

  const E = A + B - C;
  const nota = Math.max(0, Math.min(rule.max, E));
  const conc = conceitoPorNota(nota);

  currentObj.correcao.A=A; currentObj.correcao.B=B; currentObj.correcao.C=C; currentObj.correcao.E=E;
  currentObj.correcao.nota=Number(nota.toFixed(3));
  currentObj.correcao.conceito=conc;

  // status sugerido
  const reprov = (currentObj.correcao.reprovacao||[]).some(Boolean);
  const sug = reprov ? "REPROVADO" : (currentObj.status || "AGUARDANDO_INSTRUTOR");

  $("pA").value=A;
  $("pB").value=B;
  $("pC").value=C;
  $("pE").value=E;
  $("nota").value = currentObj.correcao.nota.toFixed(3);
  $("conceito").value = conc;
  $("statusShow").value = sug;
}

async function salvar(validar){
  if(!currentId||!currentObj) return;
  currentObj.correcao.obsInstr = safe($("obsInstr").value);

  const reprov = (currentObj.correcao.reprovacao||[]).some(Boolean);
  const patch={ correcao: currentObj.correcao };
  if(validar){
    patch.status = reprov ? "REPROVADO" : "FINALIZADO";
    patch.validadoEm = isoNow();
    patch.validadoPor = session.user;
  } else {
    patch.status = "AGUARDANDO_INSTRUTOR";
  }

  try{
    await rtdbPatch(`avaliacoes/${currentId}`, patch);
    const re = currentObj.aluno1?.re;
    if(re) await rtdbPut(`indexPorRE/${encodeURIComponent(re)}/${currentId}`, true);
    alert(validar ? "‚úÖ Validado." : "‚úÖ Salvo.");
    currentObj.status = patch.status;
    $("statusShow").value = patch.status;
    loadInstrList();
  }catch(e){ console.error(e); alert("Erro ao salvar/validar. Verifique Rules/Conex√£o."); }
}

function zerarTiros(){ const rule=RULES[currentObj.tipo]; currentObj.correcao.tiros=Array(rule.shots).fill(0); buildShots(rule); recomputeAll(); }
function maxTiros(){ const rule=RULES[currentObj.tipo]; const mx=Math.max(...rule.shotOptions); currentObj.correcao.tiros=Array(rule.shots).fill(mx); buildShots(rule); recomputeAll(); }
function allProc(val){ const rule=RULES[currentObj.tipo]; currentObj.correcao.procedimentosOK=Array(rule.procCount).fill(val); buildProcedures(rule); recomputeAll(); }
function clearPen(){ currentObj.correcao.penalidadesQtd={}; buildPenalties(RULES[currentObj.tipo]); recomputeAll(); }

/*************** S√öMULA (visualiza√ß√£o mobile / impress√£o desktop) ***************/
async function fetchAssinatura(){
  try{
    const sig = await rtdbGet(`config/instrutores/${encodeURIComponent(INSTRUTOR_USER)}/assinatura`);
    return sig && sig.dataUrl ? sig : null;
  }catch(e){ return null; }
}

function escHtml(s){ return (s??"").toString().replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }

function renderSumulaHTML(id, obj, sig){
  const rule = RULES[obj.tipo];
  const t = TEXTOS[obj.tipo];
  const a = obj.aluno1 || {};
  const c = obj.correcao || {};
  const penQtd = c.penalidadesQtd || {};

  // procedimentos (certo/errado)
  const procRows = t.proc.map((desc, i)=> {
    const ok = (c.procedimentosOK||[])[i] !== false;
    return `<tr><td>${String(i+1).padStart(2,"0")}</td><td>${escHtml(desc)}</td><td style="text-align:center">${ok ? "X" : ""}</td><td style="text-align:center">${!ok ? "X" : ""}</td></tr>`;
  }).join("");

  const penRows = t.pen.map((desc,i)=> {
    const q = Number(penQtd[i]||0);
    return `<tr><td>${String(i+1).padStart(2,"0")}</td><td>${escHtml(desc)}</td><td style="text-align:center">${q>0?("x"+q):""}</td><td style="text-align:center">${q>0?(q*rule.penPts):""}</td></tr>`;
  }).join("");

  const repRows = t.rep.map((desc,i)=> {
    const m = (c.reprovacao||[])[i] ? "X" : "";
    return `<tr><td>${String(i+1).padStart(2,"0")}</td><td>${escHtml(desc)}</td><td style="text-align:center">${m}</td></tr>`;
  }).join("");

  const sigBlock = sig?.dataUrl
    ? `<img src="${sig.dataUrl}" alt="assinatura"><div class="block"><div class="line">${escHtml(sig.nomeExibido||INSTRUTOR_USER)}</div><div>Professor</div></div>`
    : `<div class="block" style="flex:1"><div class="line">Assinatura do professor</div><div>(sem assinatura cadastrada)</div></div>`;

  // duas p√°ginas como no f√≠sico
  return `
  <div class="sumula" id="sumulaDoc">
    <div class="page">
      <div class="s-title">S√öMULA PARA HABILITAR USU√ÅRIO (PPA-PADR√ÉO)</div>
      <div class="s-sub">${obj.tipo==="PPA_PISTOLA" ? "PISTOLA SEMIAUTOM√ÅTICA .40 S&W" : "ESPINGARDA CAL. 12"}</div>

      <div class="s-grid">
        <div class="s-line"><b>Data</b>${escHtml(obj.data||"")}</div>
        <div class="s-line"><b>Local</b>${escHtml(obj.local||"")}</div>
        <div class="s-line"><b>Nome</b>${escHtml(a.nome||"")}</div>
        <div class="s-line"><b>RE / Posto-Grad</b>${escHtml(a.re||"")} ‚Ä¢ ${escHtml(a.postoGrad||"")}</div>
        <div class="s-line"><b>Unidade</b>${escHtml(obj.unidade||"")}</div>
        <div class="s-line"><b>${obj.tipo==="PPA_PISTOLA"?"Pistola N¬∫":"Espingarda N¬∫"}</b>${escHtml(a.armaNumero||"")}</div>
      </div>

      <table class="s-table">
        <tr><th colspan="6">PONTUA√á√ÉO</th></tr>
        <tr>
          <th style="width:18%">M√°xima</th><th style="width:14%">A (alvos)</th><th style="width:14%">B (proced.)</th><th style="width:14%">C (penal.)</th><th style="width:14%">E (final)</th><th style="width:26%">Conceito / Nota</th>
        </tr>
        <tr>
          <td style="text-align:center">${rule.max}</td>
          <td style="text-align:center">${c.A??0}</td>
          <td style="text-align:center">${c.B??0}</td>
          <td style="text-align:center">${c.C??0}</td>
          <td style="text-align:center">${c.E??0}</td>
          <td><b>NOTA:</b> ${(c.nota??0).toFixed(3)}<br><b>CONCEITO:</b> ${escHtml(c.conceito||"")}</td>
        </tr>
      </table>

      <table class="s-table">
        <tr><th colspan="4">‚ÄúB‚Äù ‚Äì PROCEDIMENTOS (10 pts por procedimento certo)</th></tr>
        <tr><th style="width:6%">#</th><th>Descri√ß√£o</th><th style="width:10%">Certo</th><th style="width:10%">Errado</th></tr>
        ${procRows}
      </table>
    </div>

    <div class="page">
      <table class="s-table">
        <tr><th colspan="4">‚ÄúC‚Äù ‚Äì PENALIDADES (10 pts negativos por ocorr√™ncia) ‚Äî quantidade</th></tr>
        <tr><th style="width:6%">#</th><th>Descri√ß√£o</th><th style="width:12%">Qtd</th><th style="width:18%">Pts negativos</th></tr>
        ${penRows}
      </table>

      <table class="s-table">
        <tr><th colspan="3">‚ÄúD‚Äù ‚Äì REPROVA√á√ÉO (penalidades fatais)</th></tr>
        <tr><th style="width:6%">#</th><th>Descri√ß√£o</th><th style="width:12%">Marcado</th></tr>
        ${repRows}
      </table>

      <table class="s-table">
        <tr><th colspan="2">OBSERVA√á√ïES</th></tr>
        <tr><td style="width:20%"><b>Aluno</b></td><td>${escHtml(obj.obsAluno||"")}</td></tr>
        <tr><td><b>Instrutor</b></td><td>${escHtml(c.obsInstr||"")}</td></tr>
      </table>

      <div class="sig">
        <div class="block">
          <div class="line">Assinatura do Aluno</div>
          <div>${escHtml(a.postoGrad||"")} ‚Ä¢ ${escHtml(a.re||"")} ‚Ä¢ ${escHtml(a.nome||"")}</div>
        </div>
        ${sigBlock}
      </div>
    </div>
  </div>
  `;
}

async function openSumulaModal(id, obj, origin){
  const sig = await fetchAssinatura();
  $("modalTitle").textContent = origin==="consulta" ? "üìÑ S√∫mula (Consulta)" : "üìÑ S√∫mula";
  $("modalSub").textContent = `ID ${id} ‚Ä¢ ${obj.aluno1?.nome||"-"} ‚Ä¢ ${obj.tipo} ‚Ä¢ ${obj.data||"-"}`;
  $("modalBody").innerHTML = renderSumulaHTML(id, obj, sig);

  // impress√£o apenas desktop
  $("btnPrint").style.display = isDesktop() ? "" : "none";

  $("modal").style.display="flex";
}

function closeModal(){
  $("modal").style.display="none";
  $("modalBody").innerHTML="";
}

function doPrintCurrentModal(){
  // injeta no printArea e chama print (desktop)
  const html = $("modalBody").innerHTML;
  $("printArea").innerHTML = html;
  $("printArea").style.display = "block";
  window.print();
  $("printArea").style.display = "none";
  $("printArea").innerHTML = "";
}

/*************** INIT ***************/
async function init(){
  try{ await rtdbGet("config"); setBadge("ONLINE (RTDB)", true); }
  catch(e){ console.error(e); setBadge("OFFLINE / RULES BLOQUEANDO", false); }
}

window.addEventListener("DOMContentLoaded", ()=>{
  init();

  $("btnLogin").addEventListener("click", login);
  $("btnLogout").addEventListener("click", logout);

  $("btnDemoAluno").addEventListener("click", ()=>{ $("loginUser").value="123456-7"; $("loginPass").value="1234"; });
  $("btnDemoInstr").addEventListener("click", ()=>{ $("loginUser").value="Fenille"; $("loginPass").value="140965"; });

  $("btnConsultar").addEventListener("click", consultarRE);

  $("tabAluno").addEventListener("click", openAluno);
  $("tabInstr").addEventListener("click", openInstr);

  $("aRE").addEventListener("blur", carregarCadastroRE);

  $("btnEnviar").addEventListener("click", enviarCabecalho);

  $("btnZerarTiros").addEventListener("click", zerarTiros);
  $("btnMaxTiros").addEventListener("click", maxTiros);
  $("btnAllProcOK").addEventListener("click", ()=>allProc(true));
  $("btnAllProcErr").addEventListener("click", ()=>allProc(false));
  $("btnClearPen").addEventListener("click", clearPen);

  $("btnSalvar").addEventListener("click", ()=>salvar(false));
  $("btnValidar").addEventListener("click", ()=>salvar(true));
  $("btnFecharEditor").addEventListener("click", closeEditor);
  $("btnVerSumula").addEventListener("click", ()=> openSumulaModal(currentId, currentObj, "editor"));

  $("btnCloseModal").addEventListener("click", closeModal);
  $("btnPrint").addEventListener("click", doPrintCurrentModal);
  $("modal").addEventListener("click", (e)=>{ if(e.target===$("modal")) closeModal(); });
});
</script>
</body>
</html>
